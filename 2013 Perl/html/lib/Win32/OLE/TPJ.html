<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../../displayToc.js"></script>
<script language="JavaScript" src="../../../tocParas.js"></script>
<script language="JavaScript" src="../../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#INTRODUCTION">INTRODUCTION</a></li>
  <li><a href="#THE-OLE-MINDSET">THE OLE MINDSET</a></li>
  <li><a href="#WORKING-WITH-WIN32::OLE">WORKING WITH WIN32::OLE</a>
    <ul>
      <li><a href="#THE-FIRST-STEP:-CREATING-AN-OLE-SERVER-OBJECT">THE FIRST STEP: CREATING AN OLE SERVER OBJECT</a></li>
      <li><a href="#METHOD-CALLS">METHOD CALLS</a></li>
      <li><a href="#PROPERTIES">PROPERTIES</a></li>
      <li><a href="#SAMPLE-APPLICATION">SAMPLE APPLICATION</a></li>
      <li><a href="#DOWNLOADING-A-WEB-PAGE-WITH-LWP">DOWNLOADING A WEB PAGE WITH LWP</a></li>
      <li><a href="#MICROSOFT-ACCESS">MICROSOFT ACCESS</a></li>
      <li><a href="#MICROSOFT-EXCEL">MICROSOFT EXCEL</a></li>
      <li><a href="#ACTIVEX-DATA-OBJECTS">ACTIVEX DATA OBJECTS</a></li>
      <li><a href="#LOTUS-NOTES">LOTUS NOTES</a></li>
    </ul>
  </li>
  <li><a href="#VARIANTS">VARIANTS</a></li>
  <li><a href="#FURTHER-INFORMATION">FURTHER INFORMATION</a>
    <ul>
      <li><a href="#DOCUMENTATION-AND-EXAMPLE-CODE">DOCUMENTATION AND EXAMPLE CODE</a></li>
      <li><a href="#OLE-AUTOMATION-ON-OTHER-PLATFORMS">OLE AUTOMATION ON OTHER PLATFORMS</a></li>
    </ul>
  </li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
  <li><a href="#POD-ERRORS">POD ERRORS</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>The Perl Journal #10 - Win32::OLE by Jan Dubois</p>

<h1 id="INTRODUCTION">INTRODUCTION</h1>

<p>Suppose you&#39;re composing a document with Microsoft Word. You want to include an Excel spreadsheet. You could save the spreadsheet in some image format that Word can understand, and import it into your document. But if the spreadsheet changes, your document will be out of date.</p>

<p>Microsoft&#39;s OLE (Object Linking and Embedding, pronounced &quot;olay&quot;) lets one program use objects from another. In the above scenario, the spreadsheet is the object. As long as Excel makes that spreadsheet available as an OLE object, and Word knows to treat it like one, your document will always be current.</p>

<p>You can control OLE objects from Perl with the Win32::OLE module, and that&#39;s what this article is about. First, I&#39;ll show you how to &quot;think OLE,&quot; which mostly involves a lot of jargon. Next, I&#39;ll show you the mechanics involved in using Win32::OLE. Then we&#39;ll go through a Perl program that uses OLE to manipulate Microsoft Excel, Microsoft Access, and Lotus Notes. Finally, I&#39;ll talk about Variants, an internal OLE data type.</p>

<h1 id="THE-OLE-MINDSET">THE OLE MINDSET</h1>

<p>When an application makes an OLE object available for other applications to use, that&#39;s called OLE <i>automation</i>. The program using the object is called the <i>controller</i>, and the application providing the object is called the <i>server</i>. OLE automation is guided by the OLE Component Object Model (COM) which specifies how those objects must behave if they are to be used by other processes and machines.</p>

<p>There are two different types of OLE automation servers. <i>In-process</i> servers are implemented as dynamic link libraries (DLLs) and run in the same process space as the controller. <i>Out-of-process</i> servers are more interesting; they are standalone executables that exist as separate processes - possibly on a different computer.</p>

<p>The Win32::OLE module lets your Perl program act as an OLE controller. It allows Perl to be used in place of other languages like Visual Basic or Java to control OLE objects. This makes all OLE automation servers immediately available as Perl modules.</p>

<p>Don&#39;t confuse ActiveState OLE with Win32::OLE. ActiveState OLE is completely different, although future builds of ActiveState Perl (500 and up) will work with Win32::OLE.</p>

<p>Objects can expose OLE methods, properties, and events to the outside world. Methods are functions that the controller can call to make the object do something; properties describe the state of the object; and events let the controller know about external events affecting the object, such as the user clicking on a button. Since events involve asynchronous communication with their objects, they require either threads or an event loop. They are not yet supported by the Win32::OLE module, and for the same reason ActiveX controls (OCXs) are currently unsupported as well.</p>

<h1 id="WORKING-WITH-WIN32::OLE">WORKING WITH WIN32::OLE</h1>

<p>The Win32::OLE module doesn&#39;t let your Perl program create OLE objects. What it does do is let your Perl program act like a remote control for other applications-it lets your program be an OLE controller. You can take an OLE object from another application (Access, Notes, Excel, or anything else that speaks OLE) and invoke its methods or manipulate its properties.</p>

<h2 id="THE-FIRST-STEP:-CREATING-AN-OLE-SERVER-OBJECT">THE FIRST STEP: CREATING AN OLE SERVER OBJECT</h2>

<p>First, we need to create a Perl object to represent the OLE server. This is a weird idea; what it amounts to is that if we want to control OLE objects produced by, say, Excel, we have to create a Perl object that represents Excel. So even though our program is an OLE controller, it&#39;ll contain objects that represent OLE servers.</p>

<p>You can create a new OLE <i>server object</i> with <code><code>Win32::OLE-&gt;new</code></code>. This takes a program ID (a human readable string like <code><code>&#39;Speech.VoiceText&#39;</code></code>) and returns a server object:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$server</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'Excel.Application'</span><span class="operator">,</span> <span class="string">'Quit'</span><span class="operator">);</span>
</code></code></pre>

<p>Some server objects (particularly those for Microsoft Office applications) don&#39;t automatically terminate when your program no longer needs them. They need some kind of Quit method, and that&#39;s just what our second argument is. It can be either a code reference or a method name to be invoked when the object is destroyed. This lets you ensure that objects will be properly cleaned up even when the Perl program dies abnormally.</p>

<p>To access a server object on a different computer, replace the first argument with a reference to a list of the server name and program ID:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$server</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="operator">[</span><span class="string">'foo.bar.com'</span><span class="operator">,</span>
                                <span class="string">'Excel.Application'</span><span class="operator">]</span><span class="operator">);</span>
</code></code></pre>

<p>(To get the requisite permissions, you&#39;ll need to configure your security settings with <i>DCOMCNFG.EXE</i>.)</p>

<p>You can also directly attach your program to an already running OLE server:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$server</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">GetActiveObject</span><span class="operator">(</span><span class="string">'Excel.Application'</span><span class="operator">);</span>
</code></code></pre>

<p>This fails (returning <code><code>undef</code></code>) if no server exists, or if the server refuses the connection for some reason. It is also possible to use a persistent object moniker (usually a filename) to start the associated server and load the object into memory:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$doc</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">GetObject</span><span class="operator">(</span><span class="string">"MyDocument.Doc"</span><span class="operator">);</span>
</code></code></pre>

<h2 id="METHOD-CALLS">METHOD CALLS</h2>

<p>Once you&#39;ve created one of these server objects, you need to call its methods to make the OLE objects sing and dance. OLE methods are invoked just like normal Perl object methods:</p>

<pre><code><code>  <span class="variable">$server</span><span class="operator">-&gt;</span><span class="variable">Foo</span><span class="operator">(</span><span class="variable">@Arguments</span><span class="operator">);</span>
</code></code></pre>

<p>This is a Perl method call - but it also triggers an OLE method call in the object. After your program executes this statement, the <code><code>$server</code></code> object will execute its Foo() method. The available methods are typically documented in the application&#39;s <i>object model</i>.</p>

<p><b>Parameters.</b> By default, all parameters are positional (e.g. <code><code>foo($first, $second, $third)</code></code>) rather than named (e.g. <code><code>foo(-name =&gt; &quot;Yogi&quot;, -title =&gt; &quot;Coach&quot;)</code></code>). The required parameters come first, followed by the optional parameters; if you need to provide a dummy value for an optional parameter, use undef.</p>

<p>Positional parameters get cumbersome if a method takes a lot of them. You can use named arguments instead if you go to a little extra trouble - when the last argument is a reference to a hash, the key/value pairs of the hash are treated as named parameters:</p>

<pre><code><code>  <span class="variable">$server</span><span class="operator">-&gt;</span><span class="variable">Foo</span><span class="operator">(</span><span class="variable">$Pos1</span><span class="operator">,</span> <span class="variable">$Pos2</span><span class="operator">,</span> <span class="operator">{</span><span class="string">Name1</span> <span class="operator">=&gt;</span> <span class="variable">$Value1</span><span class="operator">,</span>
                              <span class="string">Name2</span> <span class="operator">=&gt;</span> <span class="variable">$Value2</span><span class="operator">}</span><span class="operator">);</span>
</code></code></pre>

<p><b>Foreign Languages and Default Methods.</b> Sometimes OLE servers use method and property names that are specific to a non-English locale. That means they might have non-ASCII characters, which aren&#39;t allowed in Perl variable names. In German, you might see <code><code>&Ouml;ffnen</code></code> used instead of <code><code>Open</code></code>. In these cases, you can use the Invoke() method:</p>

<pre><code><code>  <span class="variable">$server</span><span class="operator">-&gt;</span><span class="variable">Invoke</span><span class="operator">(</span><span class="string">'Ã–ffnen'</span><span class="operator">,</span> <span class="variable">@Arguments</span><span class="operator">);</span>
</code></code></pre>

<p>This is necessary because <code><code>$Server-&gt;&Ouml;ffnen(@Arguments)</code></code> is a syntax error in current versions of Perl.</p>

<h2 id="PROPERTIES">PROPERTIES</h2>

<p>As I said earlier, objects can expose three things to the outside world: methods, properties, and events. We&#39;ve covered methods, and Win32::OLE can&#39;t handle events. That leaves properties. But as it turns out, properties and events are largely interchangeable. Most methods have corresponding properties, and vice versa.</p>

<p>An object&#39;s properties can be accessed with a hash reference:</p>

<pre><code><code>  <span class="variable">$server</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Bar</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">$value</span><span class="operator">;</span>
  <span class="variable">$value</span> <span class="operator">=</span> <span class="variable">$server</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Bar</span><span class="operator">}</span><span class="operator">;</span>
</code></code></pre>

<p>This example sets and queries the value of the property named <code><code>Bar</code></code>. You could also have called the object&#39;s Bar() method to achieve the same effect:</p>

<pre><code><code>  <span class="variable">$value</span> <span class="operator">=</span> <span class="variable">$server</span><span class="operator">-&gt;</span><span class="variable">Bar</span><span class="operator">;</span>
</code></code></pre>

<p>However, you can&#39;t write the first line as <code><code>$server-&gt;Bar = $value</code></code>, because you can&#39;t assign to the return value of a method call. In Visual Basic, OLE automation distinguishes between assigning the name of an object and assigning its value:</p>

<pre><code><code>  Set Object = OtherObject

  Let Value = Object</code></code></pre>

<p>The <code><code>Set</code></code> statement shown here makes <code><code>Object</code></code> refer to the same object as <code><code>OtherObject</code></code>. The <code><code>Let</code></code> statement copies the value instead. (The value of an OLE object is what you get when you call the object&#39;s default method.</p>

<p>In Perl, saying <code><code>$server1 = $server2</code></code> always creates another reference, just like the <code><code>Set</code></code> in Visual Basic. If you want to assign the value instead, use the valof() function:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$value</span> <span class="operator">=</span> <span class="variable">valof</span> <span class="variable">$server</span><span class="operator">;</span>
</code></code></pre>

<p>This is equivalent to</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$value</span> <span class="operator">=</span> <span class="variable">$server</span><span class="operator">-&gt;</span><span class="variable">Invoke</span><span class="operator">(</span><span class="string">''</span><span class="operator">);</span>
</code></code></pre>

<h2 id="SAMPLE-APPLICATION">SAMPLE APPLICATION</h2>

<p>Let&#39;s look at how all of this might be used. In Listing: 1 you&#39;ll see <i>T-Bond.pl</i>, a program that uses Win32::OLE for an almost-real world application.</p>

<p>The developer of this application, Mary Lynch, is a financial futures broker. Every afternoon, she connects to the Chicago Board of Trade (CBoT) web site at http://www.cbot.com and collects the time and sales information for U.S. T-bond futures. She wants her program to create a chart that depicts the data in 15-minute intervals, and then she wants to record the data in a database for later analysis. Then she wants her program to send mail to her clients.</p>

<p>Mary&#39;s program will use Microsoft Access as a database, Microsoft Excel to produce the chart, and Lotus Notes to send the mail. It will all be controlled from a single Perl program using OLE automation. In this section, we&#39;ll go through T-Bond. pl step by step so you can see how Win32::OLE lets you control these applications.</p>

<h2 id="DOWNLOADING-A-WEB-PAGE-WITH-LWP">DOWNLOADING A WEB PAGE WITH LWP</h2>

<p>However, Mary first needs to amass the raw T-bond data by having her Perl program automatically download and parse a web page. That&#39;s the perfect job for LWP, the libwww-perl bundle available on the CPAN. LWP has nothing to do with OLE. But this is a real-world application, and it&#39;s just what Mary needs to download her data from the Chicago Board of Trade.</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">LWP::Simple</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$URL</span> <span class="operator">=</span> <span class="string">'http://www.cbot.com/mplex/quotes/tsfut'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$text</span> <span class="operator">=</span> <span class="variable">get</span><span class="operator">(</span><span class="string">"</span><span class="variable">$URL</span><span class="string">/tsf</span><span class="variable">$Contract</span><span class="string">.htm"</span><span class="operator">);</span>
</code></code></pre>

<p>She could also have used the Win32::Internet module:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">Win32::Internet</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$URL</span> <span class="operator">=</span> <span class="string">'http://www.cbot.com/mplex/quotes/tsfut'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$text</span> <span class="operator">=</span> <span class="variable">$Win32::Internet</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">-&gt;</span><span class="variable">FetchURL</span><span class="operator">(</span><span class="string">"</span><span class="variable">$URL</span><span class="string">/tsf</span><span class="variable">$Contract</span><span class="string">.htm"</span><span class="operator">);</span>
</code></code></pre>

<p>Mary wants to condense the ticker data into 15 minute bars. She&#39;s interested only in lines that look like this:</p>

<pre><code><code>  03/12/1998 US 98Mar 12116 15:28:34 Open</code></code></pre>

<p>A regular expression can be used to determine whether a line looks like this. If it does, the regex can split it up into individual fields. The price quoted above, <code><code>12116</code></code>, really means 121 16/32, and needs to be converted to 121.5. The data is then condensed into 15 minute intervals and only the first, last, highest, and lowest price during each interval are kept. The time series is stored in the array <code><code>@Bars</code></code>. Each entry in <code><code>@Bars</code></code> is a reference to a list of 5 elements: Time, Open, High, Low, and Close.</p>

<pre><code><code>  <span class="keyword">foreach</span> <span class="operator">(</span><span class="keyword">split</span> <span class="string">"\n"</span><span class="operator">,</span> <span class="variable">$text</span><span class="operator">)</span> <span class="operator">{</span>
      <span class="comment"># 03/12/1998 US 98Mar 12116 15:28:34 Open</span>
      <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$Date</span><span class="operator">,</span><span class="variable">$Price</span><span class="operator">,</span><span class="variable">$Hour</span><span class="operator">,</span><span class="variable">$Min</span><span class="operator">,</span><span class="variable">$Sec</span><span class="operator">,</span><span class="variable">$Ind</span><span class="operator">)</span> <span class="operator">=</span>
           <span class="regex">m|^\s*(\d+/\d+/\d+) # " 03/12/1998"
              \s+US\s+\S+\s+(\d+) # " US 98Mar 12116"
              \s+(\d+):(\d+):(\d+) # " 12:42:40"
              \s*(.*)$|x</span><span class="operator">;</span> <span class="comment"># " Ask"</span>
      <span class="keyword">next</span> <span class="keyword">unless</span> <span class="keyword">defined</span> <span class="variable">$Date</span><span class="operator">;</span>
      <span class="variable">$Day</span> <span class="operator">=</span> <span class="variable">$Date</span><span class="operator">;</span>
  
      <span class="comment"># Convert from fractional to decimal format</span>
      <span class="variable">$Price</span> <span class="operator">=</span> <span class="keyword">int</span><span class="operator">(</span><span class="variable">$Price</span><span class="operator">/</span><span class="number">100</span><span class="operator">)</span> <span class="operator">+</span> <span class="operator">(</span><span class="variable">$Price</span><span class="variable">%100</span><span class="operator">)/</span><span class="number">32</span><span class="operator">;</span>
  
      <span class="comment"># Round up time to next multiple of 15 minutes</span>
      <span class="keyword">my</span> <span class="variable">$NewTime</span> <span class="operator">=</span> <span class="keyword">int</span><span class="operator">((</span><span class="variable">$Sec</span><span class="operator">+</span><span class="variable">$Min</span><span class="operator">*</span><span class="number">60</span><span class="operator">+</span><span class="variable">$Hour</span><span class="operator">*</span><span class="number">3600</span><span class="operator">)/</span><span class="number">900</span><span class="operator">+</span><span class="number">1</span><span class="operator">)*</span><span class="number">900</span><span class="operator">;</span>
      <span class="keyword">unless</span> <span class="operator">(</span><span class="keyword">defined</span> <span class="variable">$Time</span> <span class="operator">&amp;&amp;</span> <span class="variable">$NewTime</span> <span class="operator">==</span> <span class="variable">$Time</span><span class="operator">)</span> <span class="operator">{</span>
          <span class="keyword">push</span> <span class="variable">@Bars</span><span class="operator">,</span> <span class="operator">[</span><span class="variable">$hhmm</span><span class="operator">,</span> <span class="variable">$Open</span><span class="operator">,</span> <span class="variable">$High</span><span class="operator">,</span> <span class="variable">$Low</span><span class="operator">,</span> <span class="variable">$Close</span><span class="operator">]</span>
                                            <span class="keyword">if</span> <span class="keyword">defined</span> <span class="variable">$Time</span><span class="operator">;</span>
          <span class="variable">$Open</span> <span class="operator">=</span> <span class="variable">$High</span> <span class="operator">=</span> <span class="variable">$Low</span> <span class="operator">=</span> <span class="variable">$Close</span> <span class="operator">=</span> <span class="keyword">undef</span><span class="operator">;</span>
          <span class="variable">$Time</span> <span class="operator">=</span> <span class="variable">$NewTime</span><span class="operator">;</span>
          <span class="keyword">my</span> <span class="variable">$Hour</span> <span class="operator">=</span> <span class="keyword">int</span><span class="operator">(</span><span class="variable">$Time</span><span class="operator">/</span><span class="number">3600</span><span class="operator">);</span>
          <span class="variable">$hhmm</span> <span class="operator">=</span> <span class="keyword">sprintf</span> <span class="string">"%02d:%02d"</span><span class="operator">,</span> <span class="variable">$Hour</span><span class="operator">,</span> <span class="variable">$Time</span><span class="operator">/</span><span class="number">60</span><span class="operator">-</span><span class="variable">$Hour</span><span class="operator">*</span><span class="number">60</span><span class="operator">;</span>
      <span class="operator">}</span>
  
      <span class="comment"># Update 15 minute bar values</span>
      <span class="variable">$Close</span> <span class="operator">=</span> <span class="variable">$Price</span><span class="operator">;</span>
      <span class="variable">$Open</span> <span class="operator">=</span> <span class="variable">$Price</span> <span class="keyword">unless</span> <span class="keyword">defined</span> <span class="variable">$Open</span><span class="operator">;</span>
      <span class="variable">$High</span> <span class="operator">=</span> <span class="variable">$Price</span> <span class="keyword">unless</span> <span class="keyword">defined</span> <span class="variable">$High</span> <span class="operator">&amp;&amp;</span> <span class="variable">$High</span> <span class="operator">&gt;</span> <span class="variable">$Price</span><span class="operator">;</span>
      <span class="variable">$Low</span> <span class="operator">=</span> <span class="variable">$Price</span> <span class="keyword">unless</span> <span class="keyword">defined</span> <span class="variable">$Low</span> <span class="operator">&amp;&amp;</span> <span class="variable">$Low</span> <span class="operator">&gt;</span> <span class="variable">$Price</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="keyword">die</span> <span class="string">"No data found"</span> <span class="keyword">unless</span> <span class="keyword">defined</span> <span class="variable">$Time</span><span class="operator">;</span>
  <span class="keyword">push</span> <span class="variable">@Bars</span><span class="operator">,</span> <span class="operator">[</span><span class="variable">$hhmm</span><span class="operator">,</span> <span class="variable">$Open</span><span class="operator">,</span> <span class="variable">$High</span><span class="operator">,</span> <span class="variable">$Low</span><span class="operator">,</span> <span class="variable">$Close</span><span class="operator">]</span><span class="operator">;</span>
</code></code></pre>

<h2 id="MICROSOFT-ACCESS">MICROSOFT ACCESS</h2>

<p>Now that Mary has her T-bond quotes, she&#39;s ready to use Win32::OLE to store them into a Microsoft Access database. This has the advantage that she can copy the database to her lap-top and work with it on her long New York commute. She&#39;s able to create an Access database as follows:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">Win32::ODBC</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Win32::OLE</span><span class="operator">;</span>
  
  <span class="comment"># Include the constants for the Microsoft Access</span>
  <span class="comment"># "Data Access Object".</span>
  
  <span class="keyword">use</span> <span class="variable">Win32::OLE::Const</span> <span class="string">'Microsoft DAO'</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$DSN</span>      <span class="operator">=</span> <span class="string">'T-Bonds'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Driver</span>   <span class="operator">=</span> <span class="string">'Microsoft Access Driver (*.mdb)'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Desc</span>     <span class="operator">=</span> <span class="string">'US T-Bond Quotes'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Dir</span>      <span class="operator">=</span> <span class="string">'i:\tmp\tpj'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$File</span>     <span class="operator">=</span> <span class="string">'T-Bonds.mdb'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Fullname</span> <span class="operator">=</span> <span class="string">"</span><span class="variable">$Dir</span><span class="string">\\</span><span class="variable">$File</span><span class="string">"</span><span class="operator">;</span>
  
  <span class="comment"># Remove old database and dataset name</span>
  <span class="keyword">unlink</span> <span class="variable">$Fullname</span> <span class="keyword">if</span> <span class="keyword">-f</span> <span class="variable">$Fullname</span><span class="operator">;</span>
  <span class="variable">Win32::ODBC::ConfigDSN</span><span class="operator">(</span><span class="variable">ODBC_REMOVE_DSN</span><span class="operator">,</span> <span class="variable">$Driver</span><span class="operator">,</span> <span class="string">"DSN=</span><span class="variable">$DSN</span><span class="string">"</span><span class="operator">)</span>
                         <span class="keyword">if</span> <span class="variable">Win32::ODBC::DataSources</span><span class="operator">(</span><span class="variable">$DSN</span><span class="operator">);</span>
  
  <span class="comment"># Create new database</span>
  <span class="keyword">my</span> <span class="variable">$Access</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'Access.Application'</span><span class="operator">,</span> <span class="string">'Quit'</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$Workspace</span> <span class="operator">=</span> <span class="variable">$Access</span><span class="operator">-&gt;</span><span class="variable">DBEngine</span><span class="operator">-&gt;</span><span class="variable">CreateWorkspace</span><span class="operator">(</span><span class="string">''</span><span class="operator">,</span> <span class="string">'Admin'</span><span class="operator">,</span> <span class="string">''</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$Database</span> <span class="operator">=</span> <span class="variable">$Workspace</span><span class="operator">-&gt;</span><span class="variable">CreateDatabase</span><span class="operator">(</span><span class="variable">$Fullname</span><span class="operator">,</span> <span class="variable">dbLangGeneral</span><span class="operator">);</span>
  
  <span class="comment"># Add new database name</span>
  <span class="variable">Win32::ODBC::ConfigDSN</span><span class="operator">(</span><span class="variable">ODBC_ADD_DSN</span><span class="operator">,</span> <span class="variable">$Driver</span><span class="operator">,</span>
          <span class="string">"DSN=</span><span class="variable">$DSN</span><span class="string">"</span><span class="operator">,</span> <span class="string">"Description=</span><span class="variable">$Desc</span><span class="string">"</span><span class="operator">,</span> <span class="string">"DBQ=</span><span class="variable">$Fullname</span><span class="string">"</span><span class="operator">,</span>
          <span class="string">"DEFAULTDIR=</span><span class="variable">$Dir</span><span class="string">"</span><span class="operator">,</span> <span class="string">"UID="</span><span class="operator">,</span> <span class="string">"PWD="</span><span class="operator">);</span>
</code></code></pre>

<p>This uses Win32::ODBC (described in TPJ #9) to remove and create <i>T-Bonds.mdb</i>. This lets Mary use the same script on her workstation and on her laptop even when the database is stored in different locations on each. The program also uses Win32::OLE to make Microsoft Access create an empty database.</p>

<p>Every OLE server has some constants that your Perl program will need to use, made accessible by the Win32::OLE::Const module. For instance, to grab the Excel constants, say <code><code>use Win32::OLE::Const &#39;Microsoft Excel&#39;</code></code>.</p>

<p>In the above example, we imported the Data Access Object con-stants just so we could use <code><code>dbLangGeneral</code></code>.</p>

<h2 id="MICROSOFT-EXCEL">MICROSOFT EXCEL</h2>

<p>Now Mary uses Win32::OLE a second time, to have Microsoft Excel create the chart shown below.</p>

<pre><code><code>  <span class="variable">Figure</span> <span class="number">1</span><span class="operator">:</span> <span class="variable">T</span><span class="operator">-</span><span class="variable">Bond</span> <span class="variable">data</span> <span class="variable">generated</span> <span class="variable">by</span> <span class="variable">MicroSoft</span> <span class="variable">Excel</span> <span class="variable">via</span> <span class="variable">Win32::OLE</span>
  
  <span class="comment"># Start Excel and create new workbook with a single sheet</span>
  <span class="keyword">use</span> <span class="variable">Win32::OLE</span> <span class="string">qw(in valof with)</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Win32::OLE::Const</span> <span class="string">'Microsoft Excel'</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Win32::OLE::NLS</span> <span class="string">qw(:DEFAULT :LANG :SUBLANG)</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$lgid</span> <span class="operator">=</span> <span class="variable">MAKELANGID</span><span class="operator">(</span><span class="variable">LANG_ENGLISH</span><span class="operator">,</span> <span class="variable">SUBLANG_DEFAULT</span><span class="operator">);</span>
  <span class="variable">$Win32::OLE::LCID</span> <span class="operator">=</span> <span class="variable">MAKELCID</span><span class="operator">(</span><span class="variable">$lgid</span><span class="operator">);</span>
  
  <span class="variable">$Win32::OLE::Warn</span> <span class="operator">=</span> <span class="number">3</span><span class="operator">;</span>
</code></code></pre>

<p>Here, Mary sets the locale to American English, which lets her do things like use American date formats (e.g. <code><code>&quot;12-30-98&quot;</code></code> rather than <code><code>&quot;30-12-98&quot;</code></code>) in her program. It will continue to work even when she&#39;s visiting one of her international customers and has to run this program on their computers.</p>

<p>The value of <code><code>$Win32::OLE::Warn</code></code> determines what happens when an OLE error occurs. If it&#39;s 0, the error is ignored. If it&#39;s 2, or if it&#39;s 1 and the script is running under <code><code>-w</code></code>, the Win32::OLE module invokes <code><code>Carp::carp()</code></code>. If <code><code>$Win32::OLE::Warn</code></code> is set to 3, <code><code>Carp::croak()</code></code> is invoked and the program dies immediately.</p>

<p>Now the data can be put into an Excel spreadsheet to produce the chart. The following section of the program launches Excel and creates a new workbook with a single worksheet. It puts the column titles (&#39;Time&#39;, &#39;Open&#39;, &#39;High&#39;, &#39;Low&#39;, and &#39;Close&#39;) in a bold font on the first row of the sheet. The first column displays the timestamp in <i>hh:mm</i> format; the next four display prices.</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$Excel</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'Excel.Application'</span><span class="operator">,</span> <span class="string">'Quit'</span><span class="operator">);</span>
  <span class="variable">$Excel</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">SheetsInNewWorkbook</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Book</span> <span class="operator">=</span> <span class="variable">$Excel</span><span class="operator">-&gt;</span><span class="variable">Workbooks</span><span class="operator">-&gt;</span><span class="variable">Add</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Sheet</span> <span class="operator">=</span> <span class="variable">$Book</span><span class="operator">-&gt;</span><span class="variable">Worksheets</span><span class="operator">(</span><span class="number">1</span><span class="operator">);</span>
  <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Name</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">'Candle'</span><span class="operator">;</span>
  
  <span class="comment"># Insert column titles</span>
  <span class="keyword">my</span> <span class="variable">$Range</span> <span class="operator">=</span> <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Range</span><span class="operator">(</span><span class="string">"A1:E1"</span><span class="operator">);</span>
  <span class="variable">$Range</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Value</span><span class="operator">}</span> <span class="operator">=</span> <span class="operator">[</span><span class="string">qw(Time Open High Low Close)</span><span class="operator">]</span><span class="operator">;</span>
  <span class="variable">$Range</span><span class="operator">-&gt;</span><span class="variable">Font</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Bold</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
  
  <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Columns</span><span class="operator">(</span><span class="string">"A:A"</span><span class="operator">)-&gt;</span><span class="operator">{</span><span class="string">NumberFormat</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">"h:mm"</span><span class="operator">;</span>
  <span class="comment"># Open/High/Low/Close to be displayed in 32nds</span>
  <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Columns</span><span class="operator">(</span><span class="string">"B:E"</span><span class="operator">)-&gt;</span><span class="operator">{</span><span class="string">NumberFormat</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">"# ?/32"</span><span class="operator">;</span>
  
  <span class="comment"># Add 15 minute data to spreadsheet</span>
  <span class="keyword">print</span> <span class="string">"Add data\n"</span><span class="operator">;</span>
  <span class="variable">$Range</span> <span class="operator">=</span> <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Range</span><span class="operator">(</span><span class="keyword">sprintf</span> <span class="string">"A2:E%d"</span><span class="operator">,</span> <span class="number">2</span><span class="operator">+</span><span class="variable">$#Bars</span><span class="operator">);</span>
  <span class="variable">$Range</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Value</span><span class="operator">}</span> <span class="operator">=</span> <span class="operator">\</span><span class="variable">@Bars</span><span class="operator">;</span>
</code></code></pre>

<p>The last statement shows how to pass arrays to OLE objects. The Win32::OLE module automatically translates each array reference to a <code><code>SAFEARRAY</code></code>, the internal OLE array data type. This translation first determines the maximum nesting level used by the Perl array, and then creates a <code><code>SAFEARRAY</code></code> of the same dimension. The <code><code>@Bars</code></code> array already contains the data in the correct form for the spreadsheet:</p>

<pre><code><code>  ([Time1, Open1, High1, Low1, Close1],
  ...
  [TimeN, OpenN, HighN, LowN, CloseN])</code></code></pre>

<p>Now the table in the spreadsheet can be used to create a candle stick chart from our bars. Excel automatically chooses the time axis labels if they are selected before the chart is created:</p>

<pre><code><code>  <span class="comment"># Create candle stick chart as new object on worksheet</span>
  <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Range</span><span class="operator">(</span><span class="string">"A:E"</span><span class="operator">)-&gt;</span><span class="variable">Select</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$Chart</span> <span class="operator">=</span> <span class="variable">$Book</span><span class="operator">-&gt;</span><span class="variable">Charts</span><span class="operator">-&gt;</span><span class="variable">Add</span><span class="operator">;</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">ChartType</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">xlStockOHLC</span><span class="operator">;</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">Location</span><span class="operator">(</span><span class="variable">xlLocationAsObject</span><span class="operator">,</span> <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Name</span><span class="operator">}</span><span class="operator">);</span>
  <span class="comment"># Excel bug: the old $Chart is now invalid!</span>
  <span class="variable">$Chart</span> <span class="operator">=</span> <span class="variable">$Excel</span><span class="operator">-&gt;</span><span class="variable">ActiveChart</span><span class="operator">;</span>
</code></code></pre>

<p>We can change the type of the chart from a separate sheet to a chart object on the spreadsheet page with the <code><code>$Chart-&gt;Location</code></code> method. (This invalidates the chart object handle, which might be considered a bug in Excel.) Fortunately, this new chart is still the &#39;active&#39; chart, so an object handle to it can be reclaimed simply by asking Excel.</p>

<p>At this point, our chart still needs a title, the legend is meaningless, and the axis has decimals instead of fractions. We can fix those with the following code:</p>

<pre><code><code>  <span class="comment"># Add title, remove legend</span>
  <span class="variable">with</span><span class="operator">(</span><span class="variable">$Chart</span><span class="operator">,</span> <span class="string">HasLegend</span> <span class="operator">=&gt;</span> <span class="number">0</span><span class="operator">,</span> <span class="string">HasTitle</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">);</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">ChartTitle</span><span class="operator">-&gt;</span><span class="variable">Characters</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Text</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">"US T-Bond"</span><span class="operator">;</span>
  
  <span class="comment"># Set up daily statistics</span>
  <span class="variable">$Open</span>  <span class="operator">=</span> <span class="variable">$Bars</span><span class="operator">[</span><span class="number">0</span><span class="operator">][</span><span class="number">1</span><span class="operator">]</span><span class="operator">;</span>
  <span class="variable">$High</span>  <span class="operator">=</span> <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Evaluate</span><span class="operator">(</span><span class="string">"MAX(C:C)"</span><span class="operator">);</span>
  <span class="variable">$Low</span>   <span class="operator">=</span> <span class="variable">$Sheet</span><span class="operator">-&gt;</span><span class="variable">Evaluate</span><span class="operator">(</span><span class="string">"MIN(D:D)"</span><span class="operator">);</span>
  <span class="variable">$Close</span> <span class="operator">=</span> <span class="variable">$Bars</span><span class="operator">[</span><span class="variable">$#Bars</span><span class="operator">][</span><span class="number">4</span><span class="operator">]</span><span class="operator">;</span>
</code></code></pre>

<p>The with() function partially mimics the Visual Basic With statement, but allows only property assignments. It&#39;s a convenient shortcut for this:</p>

<pre><code><code>  <span class="operator">{</span> <span class="comment"># open new scope</span>
    <span class="keyword">my</span> <span class="variable">$Axis</span> <span class="operator">=</span> <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">Axes</span><span class="operator">(</span><span class="variable">xlValue</span><span class="operator">);</span>
    <span class="variable">$Axis</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">HasMajorGridlines</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
    <span class="variable">$Axis</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">HasMinorGridlines</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
    <span class="comment"># etc ...</span>
  <span class="operator">}</span>
</code></code></pre>

<p>The <code><code>$High</code></code> and <code><code>$Low</code></code> for the day are needed to determine the minimum and maximum scaling levels. MIN and MAX are spreadsheet functions, and aren&#39;t automatically available as methods. However, Excel provides an Evaluate() method to calculate arbitrary spreadsheet functions, so we can use that.</p>

<p>We want the chart to show major gridlines at every fourth tick and minor gridlines at every second tick. The minimum and maximum are chosen to be whatever multiples of 1/16 we need to do that.</p>

<pre><code><code>  <span class="comment"># Change tickmark spacing from decimal to fractional</span>
  <span class="variable">with</span><span class="operator">(</span><span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">Axes</span><span class="operator">(</span><span class="variable">xlValue</span><span class="operator">),</span>
      <span class="string">HasMajorGridlines</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
      <span class="string">HasMinorGridlines</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
      <span class="string">MajorUnit</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">/</span><span class="number">8</span><span class="operator">,</span>
      <span class="string">MinorUnit</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">/</span><span class="number">16</span><span class="operator">,</span>
      <span class="string">MinimumScale</span> <span class="operator">=&gt;</span> <span class="keyword">int</span><span class="operator">(</span><span class="variable">$Low</span><span class="operator">*</span><span class="number">16</span><span class="operator">)/</span><span class="number">16</span><span class="operator">,</span>
      <span class="string">MaximumScale</span> <span class="operator">=&gt;</span> <span class="keyword">int</span><span class="operator">(</span><span class="variable">$High</span><span class="operator">*</span><span class="number">16</span><span class="operator">+</span><span class="number">1</span><span class="operator">)/</span><span class="number">16</span>
  <span class="operator">);</span>
  
  <span class="comment"># Fat candles with only 5% gaps</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">ChartGroups</span><span class="operator">(</span><span class="number">1</span><span class="operator">)-&gt;</span><span class="operator">{</span><span class="string">GapWidth</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">5</span><span class="operator">;</span>
  
  <span class="keyword">sub</span><span class="variable"> RGB </span><span class="operator">{</span> <span class="variable">$_</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span> <span class="operator">|</span> <span class="operator">(</span><span class="variable">$_</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span> <span class="operator">&gt;&gt;</span> <span class="number">8</span><span class="operator">)</span> <span class="operator">|</span> <span class="operator">(</span><span class="variable">$_</span><span class="operator">[</span><span class="number">2</span><span class="operator">]</span> <span class="operator">&gt;&gt;</span> <span class="number">16</span><span class="operator">)</span> <span class="operator">}</span>
  
  <span class="comment"># White background with a solid border</span>
  
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">PlotArea</span><span class="operator">-&gt;</span><span class="variable">Border</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">LineStyle</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">xlContinuous</span><span class="operator">;</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">PlotArea</span><span class="operator">-&gt;</span><span class="variable">Border</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Color</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">RGB</span><span class="operator">(</span><span class="number">0</span><span class="operator">,</span><span class="number">0</span><span class="operator">,</span><span class="number">0</span><span class="operator">);</span>
  <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">PlotArea</span><span class="operator">-&gt;</span><span class="variable">Interior</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Color</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">RGB</span><span class="operator">(</span><span class="number">255</span><span class="operator">,</span><span class="number">255</span><span class="operator">,</span><span class="number">255</span><span class="operator">);</span>
  
  <span class="comment"># Add 1 hour moving average of the Close series</span>
  <span class="keyword">my</span> <span class="variable">$MovAvg</span> <span class="operator">=</span> <span class="variable">$Chart</span><span class="operator">-&gt;</span><span class="variable">SeriesCollection</span><span class="operator">(</span><span class="number">4</span><span class="operator">)-&gt;</span><span class="variable">Trendlines</span>
        <span class="operator">-&gt;</span><span class="variable">Add</span><span class="operator">(</span><span class="operator">{</span><span class="string">Type</span> <span class="operator">=&gt;</span> <span class="variable">xlMovingAvg</span><span class="operator">,</span> <span class="string">Period</span> <span class="operator">=&gt;</span> <span class="number">4</span><span class="operator">}</span><span class="operator">);</span>
  <span class="variable">$MovAvg</span><span class="operator">-&gt;</span><span class="variable">Border</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Color</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">RGB</span><span class="operator">(</span><span class="number">255</span><span class="operator">,</span><span class="number">0</span><span class="operator">,</span><span class="number">0</span><span class="operator">);</span>
</code></code></pre>

<p>Now the finished workbook can be saved to disk as <i>i:\tmp\tpj\data.xls</i>. That file most likely still exists from when the program ran yesterday, so we&#39;ll remove it. (Otherwise, Excel would pop up a dialog with a warning, because the SaveAs() method doesn&#39;t like to overwrite files.)</p>

<pre><code><code>  <span class="comment"># Save workbook to file my $Filename = 'i:\tmp\tpj\data.xls';</span>
  <span class="keyword">unlink</span> <span class="variable">$Filename</span> <span class="keyword">if</span> <span class="keyword">-f</span> <span class="variable">$Filename</span><span class="operator">;</span>
  <span class="variable">$Book</span><span class="operator">-&gt;</span><span class="variable">SaveAs</span><span class="operator">(</span><span class="variable">$Filename</span><span class="operator">);</span>
  <span class="variable">$Book</span><span class="operator">-&gt;</span><span class="variable">Close</span><span class="operator">;</span>
</code></code></pre>

<h2 id="ACTIVEX-DATA-OBJECTS">ACTIVEX DATA OBJECTS</h2>

<p>Mary stores the daily prices in her T-bonds database, keeping the data for the different contracts in separate tables. After creating an ADO (ActiveX Data Object) connection to the database, she tries to connect a record set to the table for the current contract. If this fails, she assumes that the table doesn&#39;t exists yet and tries to create it:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">Win32::OLE::Const</span> <span class="string">'Microsoft ActiveX Data Objects'</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$Connection</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'ADODB.Connection'</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$Recordset</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'ADODB.Recordset'</span><span class="operator">);</span>
  <span class="variable">$Connection</span><span class="operator">-&gt;</span><span class="variable">Open</span><span class="operator">(</span><span class="string">'T-Bonds'</span><span class="operator">);</span>
  
  <span class="comment"># Open a record set for the table of this contract</span>
  <span class="operator">{</span>
    <span class="keyword">local</span> <span class="variable">$Win32::OLE::Warn</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
    <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Open</span><span class="operator">(</span><span class="variable">$Contract</span><span class="operator">,</span> <span class="variable">$Connection</span><span class="operator">,</span> <span class="variable">adOpenKeyset</span><span class="operator">,</span>
                         <span class="variable">adLockOptimistic</span><span class="operator">,</span> <span class="variable">adCmdTable</span><span class="operator">);</span>
  <span class="operator">}</span>
  
  <span class="comment"># Create table and index if it doesn't exist yet</span>
  <span class="keyword">if</span> <span class="operator">(</span><span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">LastError</span><span class="operator">)</span> <span class="operator">{</span>
      <span class="variable">$Connection</span><span class="operator">-&gt;</span><span class="variable">Execute</span><span class="operator">(&lt;&lt;</span><span class="default">"SQL"</span><span class="operator">);</span><span class="string">
        CREATE TABLE $Contract
        (
          Day DATETIME,
          Open DOUBLE, High DOUBLE, Low DOUBLE, Close DOUBLE
        )
  </span><span class="default">SQL</span>
      <span class="variable">$Connection</span><span class="operator">-&gt;</span><span class="variable">Execute</span><span class="operator">(&lt;&lt;</span><span class="default">"SQL"</span><span class="operator">);</span><span class="string">
        CREATE INDEX $Contract
        ON $Contract (Day) WITH PRIMARY
  </span><span class="default">SQL</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Open</span><span class="operator">(</span><span class="variable">$Contract</span><span class="operator">,</span> <span class="variable">$Connection</span><span class="operator">,</span> <span class="variable">adOpenKeyset</span><span class="operator">,</span>
                                <span class="variable">adLockOptimistic</span><span class="operator">,</span> <span class="variable">adCmdTable</span><span class="operator">);</span>
  <span class="operator">}</span>
</code></code></pre>

<p><code><code>$Win32::OLE::Warn</code></code> is temporarily set to zero, so that if <code><code>$Recordset-</code></code>Open&gt; fails, the failure will be recorded silently without terminating the program. <code><code>Win32::OLE-</code></code>LastError&gt; shows whether the Open failed or not. <code><code>LastError</code></code> returns the OLE error code in a numeric context and the OLE error message in a string context, just like Perl&#39;s <code><code>$!</code></code> variable.</p>

<p>Now Mary can add today&#39;s data:</p>

<pre><code><code>  <span class="comment"># Add new record to table</span>
  <span class="keyword">use</span> <span class="variable">Win32::OLE::Variant</span><span class="operator">;</span>
  <span class="variable">$Win32::OLE::Variant::LCID</span> <span class="operator">=</span> <span class="variable">$Win32::OLE::LCID</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$Fields</span> <span class="operator">=</span> <span class="operator">[</span><span class="string">qw(Day Open High Low Close)</span><span class="operator">]</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Values</span> <span class="operator">=</span> <span class="operator">[</span><span class="variable">Variant</span><span class="operator">(</span><span class="variable">VT_DATE</span><span class="operator">,</span> <span class="variable">$Day</span><span class="operator">),</span>
                <span class="variable">$Open</span><span class="operator">,</span> <span class="variable">$High</span><span class="operator">,</span> <span class="variable">$Low</span><span class="operator">,</span> <span class="variable">$Close</span><span class="operator">]</span><span class="operator">;</span>
</code></code></pre>

<p>Mary uses the Win32::OLE::Variant module to store <code><code>$Day</code></code> as a date instead of a mere string. She wants to make sure that it&#39;s stored as an American-style date, so in the third line shown here she sets the locale ID of the Win32::OLE::Variant module to match the Win32::OLE module. (<code><code>$Win32::OLE::LCID</code></code> had been set earlier to English, since that&#39;s what the Chicago Board of Trade uses.)</p>

<pre><code><code>  <span class="operator">{</span>
      <span class="keyword">local</span> <span class="variable">$Win32::OLE::Warn</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">AddNew</span><span class="operator">(</span><span class="variable">$Fields</span><span class="operator">,</span> <span class="variable">$Values</span><span class="operator">);</span>
  <span class="operator">}</span>
  
  <span class="comment"># Replace existing record</span>
  <span class="keyword">if</span> <span class="operator">(</span><span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">LastError</span><span class="operator">)</span> <span class="operator">{</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">CancelUpdate</span><span class="operator">;</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Close</span><span class="operator">;</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Open</span><span class="operator">(&lt;&lt;</span><span class="default">"SQL"</span><span class="operator">,</span> <span class="variable">$Connection</span><span class="operator">,</span> <span class="variable">adOpenDynamic</span><span class="operator">);</span><span class="string">
          SELECT * FROM $Contract
          WHERE Day = #$Day#
  </span><span class="default">SQL</span>
      <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Update</span><span class="operator">(</span><span class="variable">$Fields</span><span class="operator">,</span> <span class="variable">$Values</span><span class="operator">);</span>
  <span class="operator">}</span>
  
  <span class="variable">$Recordset</span><span class="operator">-&gt;</span><span class="variable">Close</span><span class="operator">;</span>
  <span class="variable">$Connection</span><span class="operator">-&gt;</span><span class="variable">Close</span><span class="operator">;</span>
</code></code></pre>

<p>The program expects to be able to add a new record to the table. It fails if a record for this date already exists, because the Day field is the primary index and therefore must be unique. If an error occurs, the update operation started by AddNew() must first be cancelled with <code><code>$Recordset-&gt;CancelUpdate</code></code>; otherwise the record set won&#39;t close.</p>

<h2 id="LOTUS-NOTES">LOTUS NOTES</h2>

<p>Now Mary can use Lotus Notes to mail updates to all her customers interested in the T-bond data. (Lotus Notes doesn&#39;t provide its constants in the OLE type library, so Mary had to determine them by playing around with LotusScript.) The actual task is quite simple: A Notes session must be started, the mail database must be opened and the mail message must be created. The body of the message is created as a rich text field, which lets her mix formatted text with object attachments.</p>

<p>In her program, Mary extracts the email addresses from her customer database and sends separate message to each. Here, we&#39;ve simplified it somewhat.</p>

<pre><code><code>  <span class="keyword">sub</span><span class="variable"> EMBED_ATTACHMENT </span><span class="operator">{</span><span class="number">1454</span><span class="operator">;}</span>     <span class="comment"># from LotusScript</span>
  
  <span class="keyword">my</span> <span class="variable">$Notes</span> <span class="operator">=</span> <span class="variable">Win32::OLE</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="string">'Notes.NotesSession'</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$Database</span> <span class="operator">=</span> <span class="variable">$Notes</span><span class="operator">-&gt;</span><span class="variable">GetDatabase</span><span class="operator">(</span><span class="string">''</span><span class="operator">,</span> <span class="string">''</span><span class="operator">);</span>
  <span class="variable">$Database</span><span class="operator">-&gt;</span><span class="variable">OpenMail</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$Document</span> <span class="operator">=</span> <span class="variable">$Database</span><span class="operator">-&gt;</span><span class="variable">CreateDocument</span><span class="operator">;</span>
  
  <span class="variable">$Document</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Form</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">'Memo'</span><span class="operator">;</span>
  <span class="variable">$Document</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">SendTo</span><span class="operator">}</span> <span class="operator">=</span> <span class="operator">[</span><span class="string">'Jon Orwant &gt;orwant@tpj.com&gt;'</span><span class="operator">,</span>
                         <span class="string">'Jan Dubois &gt;jan.dubois@ibm.net&gt;'</span><span class="operator">]</span><span class="operator">;</span>
  <span class="variable">$Document</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">Subject</span><span class="operator">}</span> <span class="operator">=</span> <span class="string">"US T-Bonds Chart for </span><span class="variable">$Day</span><span class="string">"</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$Body</span> <span class="operator">=</span> <span class="variable">$Document</span><span class="operator">-&gt;</span><span class="variable">CreateRichtextItem</span><span class="operator">(</span><span class="string">'Body'</span><span class="operator">);</span>
  <span class="variable">$Body</span><span class="operator">-&gt;</span><span class="variable">AppendText</span><span class="operator">(&lt;&lt;</span><span class="default">"EOT"</span><span class="operator">);</span><span class="string">
  I\'ve attached the latest US T-Bond data and chart for $Day.
  The daily statistics were:
  
  \tOpen\t$Open
  \tHigh\t$High
  \tLow\t$Low
  \tClose\t$Close
  
  Kind regards,
  
  Mary
  </span><span class="default">EOT</span>
  
  <span class="variable">$Body</span><span class="operator">-&gt;</span><span class="variable">EmbedObject</span><span class="operator">(</span><span class="variable">EMBED_ATTACHMENT</span><span class="operator">,</span> <span class="string">''</span><span class="operator">,</span> <span class="variable">$Filename</span><span class="operator">);</span>
  
  <span class="variable">$Document</span><span class="operator">-&gt;</span><span class="variable">Send</span><span class="operator">(</span><span class="number">0</span><span class="operator">);</span>
</code></code></pre>

<h1 id="VARIANTS">VARIANTS</h1>

<p>In this final section, I&#39;ll talk about Variants, which are the data types that you use to talk to OLE objects. We talked about this line earlier:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$Values</span> <span class="operator">=</span> <span class="operator">[</span><span class="variable">Variant</span><span class="operator">(</span><span class="variable">VT_DATE</span><span class="operator">,</span> <span class="variable">$Day</span><span class="operator">),</span>
                <span class="variable">$Open</span><span class="operator">,</span> <span class="variable">$High</span><span class="operator">,</span> <span class="variable">$Low</span><span class="operator">,</span> <span class="variable">$Close</span><span class="operator">]</span><span class="operator">;</span>
</code></code></pre>

<p>Here, the Variant() function creates a Variant object, of type <code><code>VT_DATE</code></code> and with the value <code><code>$Day</code></code>. Variants are similar in many ways to Perl scalars. Arguments to OLE methods are transparently converted from their internal Perl representation to Variants and back again by the Win32::OLE module.</p>

<p>OLE automation uses a generic <code><code>VARIANT</code></code> data type to pass parameters. This data type contains type information in addition to the actual data value. Only the following data types are valid for OLE automation:</p>

<pre><code><code>  B&lt;Data Type     Meaning&gt;
  VT_EMPTY      Not specified
  VT_NULL       Null
  VT_I2         2 byte signed integer
  VT_I4         4 byte signed integer
  VT_R4         4 byte real
  VT_R8         8 byte real
  VT_CY         Currency
  VT_DATE       Date
  VT_BSTR       Unicode string
  VT_DISPATCH   OLE automation interface
  VT_ERROR      Error
  VT_BOOL       Boolean
  VT_VARIANT    (only valid with VT_BYREF)
  VT_UNKNOWN    Generic COM interface
  VT_UI1        Unsigned character</code></code></pre>

<p>The following two flags can also be used:</p>

<pre><code><code>  VT_ARRAY      Array of values
  VT_BYREF      Pass by reference (instead of by value)</code></code></pre>

<p><b>The Perl to Variant transformation.</b> The following conversions are performed automatically whenever a Perl value must be translated into a Variant:</p>

<pre><code><code>  Perl value                  Variant
  Integer values              VT_I4
  Real values                 VT_R8
  Strings                     VT_BSTR
  undef                       VT_ERROR (DISP_E_PARAMNOTFOUND)
  Array reference             VT_VARIANT | VT_ARRAY
  Win32::OLE object           VT_DISPATCH
  Win32::OLE::Variant object  Type of the Variant object</code></code></pre>

<p>What if your Perl value is a list of lists? Those can be irregularly shaped in Perl; that is, the subsidiary lists needn&#39;t have the same number of elements. In this case, the structure will be converted to a &quot;rectangular&quot; <code><code>SAFEARRAY</code></code> of Variants, with unused slots set to <code><code>VT_EMPTY</code></code>. Consider this Perl 2-D array:</p>

<pre><code><code>  [ [&quot;Perl&quot; ],            # one element
    [1, 3.1215, undef]    # three elements
  ]</code></code></pre>

<p>This will be translated to a 2 by 3 <code><code>SAFEARRAY</code></code> that looks like this:</p>

<pre><code><code>  VT_BSTR(&quot;Perl&quot;) VT_EMPTY      VT_EMPTY
  VT_I4(1) VT_R8(3.1415)        VT_ERROR(DISP_E_PARAMNOTFOUND)</code></code></pre>

<p><b>The Variant To Perl Transformation.</b> Automatic conversion from Variants to Perl values happens as follows:</p>

<pre><code><code>  Variant                Perl value
  VT_BOOL, VT_ERROR      Integer
  VT_UI1, VT_I2, VT_I4   Integer
  VT_R4, VT_R8           Float value
  VT_BSTR                String
  VT_DISPATCH            Win32::OLE object</code></code></pre>

<p><b>The Win32::OLE::Variant module.</b> This module provides access to the Variant data type, which gives you more control over how these arguments to OLE methods are encoded. (This is rarely necessary if you have a good grasp of the default conversion rules.) A Variant object can be created with the <code><code>Win32::OLE::Variant-&gt;new</code></code> method or the equivalent Variant() function:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">Win32::OLE::Variant</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$var1</span> <span class="operator">=</span> <span class="variable">Win32::OLE::Variant</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="variable">VT_DATE</span><span class="operator">,</span> <span class="string">'Jan 1,1970'</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$var2</span> <span class="operator">=</span> <span class="variable">Variant</span><span class="operator">(</span><span class="variable">VT_BSTR</span><span class="operator">,</span> <span class="string">'This is an Unicode string'</span><span class="operator">);</span>
</code></code></pre>

<p>Several methods let you inspect and manipulate Variant objects: The Type() and Value() methods return the variant type and value; the As() method returns the value after converting it to a different variant type; ChangeType() coerces the Variant into a different type; and Unicode() returns the value of a Variant object as an object of the Unicode::String class.</p>

<p>These conversions are more interesting if they can be applied directly to the return value of an OLE method call without first mutilating the value with default conversions. This is possible with the following trick:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$RetVal</span> <span class="operator">=</span> <span class="variable">Variant</span><span class="operator">(</span><span class="variable">VT_EMPTY</span><span class="operator">,</span> <span class="keyword">undef</span><span class="operator">);</span>
  <span class="variable">$Object</span><span class="operator">-&gt;</span><span class="variable">Dispatch</span><span class="operator">(</span><span class="variable">$Method</span><span class="operator">,</span> <span class="variable">$RetVal</span><span class="operator">,</span> <span class="variable">@Arguments</span><span class="operator">);</span>
</code></code></pre>

<p>Normally, you wouldn&#39;t call Dispatch() directly; it&#39;s executed implicitly by either AUTOLOAD() or Invoke(). If Dispatch() realizes that the return value is already a Win32::OLE::Variant object, the return value is not translated into a Perl representation but rather copied verbatim into the Variant object.</p>

<p>Whenever a Win32::OLE::Variant object is used in a numeric or string context it is automatically converted into the corresponding format.</p>

<pre><code><code>  <span class="keyword">printf</span> <span class="string">"Number: %f and String: %s\n"</span><span class="operator">,</span>
         <span class="variable">$Var</span><span class="operator">,</span> <span class="variable">$Var</span><span class="operator">;</span>
</code></code></pre>

<p>This is equivalent to:</p>

<pre><code><code>  <span class="keyword">printf</span> <span class="string">"Number: %f and String: %s\n"</span><span class="operator">,</span>
         <span class="variable">$Var</span><span class="operator">-&gt;</span><span class="variable">As</span><span class="operator">(</span><span class="variable">VT_R8</span><span class="operator">),</span> <span class="variable">$Var</span><span class="operator">-&gt;</span><span class="variable">As</span><span class="operator">(</span><span class="variable">VT_BSTR</span><span class="operator">);</span>
</code></code></pre>

<p>For methods that modify their arguments, you need to use the <code><code>VT_BYREF</code></code> flag. This lets you create number and string Variants that can be modified by OLE methods. Here, Corel&#39;s GetSize() method takes two integers and stores the <code><code>x</code></code> and <code><code>y</code></code> dimensions in them:</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$x</span> <span class="operator">=</span> <span class="variable">Variant</span><span class="operator">(</span> <span class="variable">VT_I4</span> <span class="operator">|</span> <span class="variable">VT_BYREF</span><span class="operator">,</span> <span class="number">0</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$y</span> <span class="operator">=</span> <span class="variable">Variant</span><span class="operator">(</span> <span class="variable">VT_I4</span> <span class="operator">|</span> <span class="variable">VT_BYREF</span><span class="operator">,</span> <span class="number">0</span><span class="operator">);</span>
  <span class="variable">$Corel</span><span class="operator">-&gt;</span><span class="variable">GetSize</span><span class="operator">(</span><span class="variable">$x</span><span class="operator">,</span> <span class="variable">$y</span><span class="operator">);</span>
</code></code></pre>

<p><code><code>VT_BYREF</code></code> support for other Variant types might appear in future releases of Win32::OLE.</p>

<h1 id="FURTHER-INFORMATION">FURTHER INFORMATION</h1>

<h2 id="DOCUMENTATION-AND-EXAMPLE-CODE">DOCUMENTATION AND EXAMPLE CODE</h2>

<p>More information about the OLE modules can be found in the documentation bundled with Win32::OLE. The distribution also contains other code samples.</p>

<p>The object model for Microsoft Office applications can be found in the Visual Basic Reference for Microsoft Access, Excel, Word, or PowerPoint. These help files are not installed by default, but they can be added later by rerunning <i>setup.exe</i> and choosing <i>custom setup</i>. The object model for Microsoft Outlook can be found on the Microsoft Office Developer Forum at: http://www.microsoft.com/OutlookDev/.</p>

<p>Information about the LotusScript object model can be found at: http://www.lotus.com/products/lotusscript.nsf.</p>

<h2 id="OLE-AUTOMATION-ON-OTHER-PLATFORMS">OLE AUTOMATION ON OTHER PLATFORMS</h2>

<p>Microsoft also makes OLE technology available for the Mac. DCOM is already included in Windows NT 4.0 and can be downloaded for Windows 95. MVS and some Unix systems can use EntireX to get OLE functionality; see http://www.softwareag.com/corporat/solutions/entirex/entirex.htm.</p>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<p>Copyright 1998 <i>The Perl Journal</i>. http://www.tpj.com</p>

<p>This article originally appeared in <i>The Perl Journal</i> #10. It appears courtesy of Jon Orwant and <i>The Perl Journal</i>. This document may be distributed under the same terms as Perl itself.</p>

<h1 id="POD-ERRORS">POD ERRORS</h1>

<p>Hey! <b>The above document had some coding errors, which are explained below:</b></p>

<dl>

<dt id="Around-line-147:">Around line 147:</dt>
<dd>

<p>Non-ASCII character seen before =encoding in &#39;C&lt;&Ouml;ffnen&gt;&#39;. Assuming ISO8859-1</p>

</dd>
</dl>


</body>

</html>


