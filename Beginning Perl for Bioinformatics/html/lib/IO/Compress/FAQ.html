<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../../displayToc.js"></script>
<script language="JavaScript" src="../../../tocParas.js"></script>
<script language="JavaScript" src="../../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#GENERAL">GENERAL</a>
    <ul>
      <li><a href="#Compatibility-with-Unix-compress-uncompress.">Compatibility with Unix compress/uncompress.</a></li>
      <li><a href="#Accessing-.tar.Z-files">Accessing .tar.Z files</a></li>
      <li><a href="#How-do-I-recompress-using-a-different-compression-">How do I recompress using a different compression?</a></li>
    </ul>
  </li>
  <li><a href="#ZIP">ZIP</a>
    <ul>
      <li><a href="#What-Compression-Types-do-IO::Compress::Zip-IO::Uncompress::Unzip-support-">What Compression Types do IO::Compress::Zip &amp; IO::Uncompress::Unzip support?</a></li>
      <li><a href="#Can-I-Read-Write-Zip-files-larger-the-4-Gig-">Can I Read/Write Zip files larger the 4 Gig?</a></li>
      <li><a href="#Can-I-write-more-that-64K-entries-is-a-Zip-files-">Can I write more that 64K entries is a Zip files?</a></li>
      <li><a href="#Zip-Resources">Zip Resources</a></li>
    </ul>
  </li>
  <li><a href="#GZIP">GZIP</a>
    <ul>
      <li><a href="#Gzip-Resources">Gzip Resources</a></li>
      <li><a href="#Dealing-with-Concatenated-gzip-files">Dealing with Concatenated gzip files</a></li>
    </ul>
  </li>
  <li><a href="#ZLIB">ZLIB</a>
    <ul>
      <li><a href="#Zlib-Resources">Zlib Resources</a></li>
    </ul>
  </li>
  <li><a href="#Bzip2">Bzip2</a>
    <ul>
      <li><a href="#Bzip2-Resources">Bzip2 Resources</a></li>
      <li><a href="#Dealing-with-Concatenated-bzip2-files">Dealing with Concatenated bzip2 files</a></li>
      <li><a href="#Interoperating-with-Pbzip2">Interoperating with Pbzip2</a></li>
    </ul>
  </li>
  <li><a href="#HTTP-NETWORK">HTTP &amp; NETWORK</a>
    <ul>
      <li><a href="#Apache::GZip-Revisited">Apache::GZip Revisited</a></li>
      <li><a href="#Compressed-files-and-Net::FTP">Compressed files and Net::FTP</a></li>
    </ul>
  </li>
  <li><a href="#MISC">MISC</a>
    <ul>
      <li><a href="#Using-to-uncompress-data-embedded-in-a-larger-file-buffer.">Using  to uncompress data embedded in a larger file/buffer.</a></li>
    </ul>
  </li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
  <li><a href="#AUTHOR">AUTHOR</a></li>
  <li><a href="#MODIFICATION-HISTORY">MODIFICATION HISTORY</a></li>
  <li><a href="#COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>IO::Compress::FAQ -- Frequently Asked Questions about IO::Compress</p>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>Common questions answered.</p>

<h1 id="GENERAL">GENERAL</h1>

<h2 id="Compatibility-with-Unix-compress-uncompress.">Compatibility with Unix compress/uncompress.</h2>

<p>Although <code><code>Compress::Zlib</code></code> has a pair of functions called <code><code>compress</code></code> and <code><code>uncompress</code></code>, they are <i>not</i> related to the Unix programs of the same name. The <code><code>Compress::Zlib</code></code> module is not compatible with Unix <code><code>compress</code></code>.</p>

<p>If you have the <code><code>uncompress</code></code> program available, you can use this to read compressed files</p>

<pre><code><code>    <span class="keyword">open</span> <span class="variable">F</span><span class="operator">,</span> <span class="string">"uncompress -c </span><span class="variable">$filename</span><span class="string"> |"</span><span class="operator">;</span>
    <span class="keyword">while</span> <span class="operator">(&lt;</span><span class="variable">F</span><span class="operator">&gt;)</span>
    <span class="operator">{</span>
        <span class="operator">...</span>
</code></code></pre>

<p>Alternatively, if you have the <code><code>gunzip</code></code> program available, you can use this to read compressed files</p>

<pre><code><code>    <span class="keyword">open</span> <span class="variable">F</span><span class="operator">,</span> <span class="string">"gunzip -c </span><span class="variable">$filename</span><span class="string"> |"</span><span class="operator">;</span>
    <span class="keyword">while</span> <span class="operator">(&lt;</span><span class="variable">F</span><span class="operator">&gt;)</span>
    <span class="operator">{</span>
        <span class="operator">...</span>
</code></code></pre>

<p>and this to write compress files, if you have the <code><code>compress</code></code> program available</p>

<pre><code><code>    <span class="keyword">open</span> <span class="variable">F</span><span class="operator">,</span> <span class="string">"| compress -c </span><span class="variable">$filename</span><span class="string"> "</span><span class="operator">;</span>
    <span class="keyword">print</span> <span class="variable">F</span> <span class="string">"data"</span><span class="operator">;</span>
    <span class="operator">...</span>
    <span class="keyword">close</span> <span class="variable">F</span> <span class="operator">;</span>
</code></code></pre>

<h2 id="Accessing-.tar.Z-files">Accessing .tar.Z files</h2>

<p>The <code><code>Archive::Tar</code></code> module can optionally use <code><code>Compress::Zlib</code></code> (via the <code><code>IO::Zlib</code></code> module) to access tar files that have been compressed with <code><code>gzip</code></code>. Unfortunately tar files compressed with the Unix <code><code>compress</code></code> utility cannot be read by <code><code>Compress::Zlib</code></code> and so cannot be directly accessed by <code><code>Archive::Tar</code></code>.</p>

<p>If the <code><code>uncompress</code></code> or <code><code>gunzip</code></code> programs are available, you can use one of these workarounds to read <code><code>.tar.Z</code></code> files from <code><code>Archive::Tar</code></code></p>

<p>Firstly with <code><code>uncompress</code></code></p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">strict</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">warnings</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">Archive::Tar</span><span class="operator">;</span>
    
    <span class="keyword">open</span> <span class="variable">F</span><span class="operator">,</span> <span class="string">"uncompress -c </span><span class="variable">$filename</span><span class="string"> |"</span><span class="operator">;</span>
    <span class="keyword">my</span> <span class="variable">$tar</span> <span class="operator">=</span> <span class="variable">Archive::Tar</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="variable">*F</span><span class="operator">);</span>
    <span class="operator">...</span>
</code></code></pre>

<p>and this with <code><code>gunzip</code></code></p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">strict</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">warnings</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">Archive::Tar</span><span class="operator">;</span>
    
    <span class="keyword">open</span> <span class="variable">F</span><span class="operator">,</span> <span class="string">"gunzip -c </span><span class="variable">$filename</span><span class="string"> |"</span><span class="operator">;</span>
    <span class="keyword">my</span> <span class="variable">$tar</span> <span class="operator">=</span> <span class="variable">Archive::Tar</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="variable">*F</span><span class="operator">);</span>
    <span class="operator">...</span>
</code></code></pre>

<p>Similarly, if the <code><code>compress</code></code> program is available, you can use this to write a <code><code>.tar.Z</code></code> file</p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">strict</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">warnings</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">Archive::Tar</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">IO::File</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$fh</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::File</span> <span class="string">"| compress -c &gt;</span><span class="variable">$filename</span><span class="string">"</span><span class="operator">;</span>
    <span class="keyword">my</span> <span class="variable">$tar</span> <span class="operator">=</span> <span class="variable">Archive::Tar</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">();</span>
    <span class="operator">...</span>
    <span class="variable">$tar</span><span class="operator">-&gt;</span><span class="variable">write</span><span class="operator">(</span><span class="variable">$fh</span><span class="operator">);</span>
    <span class="variable">$fh</span><span class="operator">-&gt;</span><span class="variable">close</span> <span class="operator">;</span>
</code></code></pre>

<h2 id="How-do-I-recompress-using-a-different-compression-">How do I recompress using a different compression?</h2>

<p>This is easier that you might expect if you realise that all the <code><code>IO::Compress::*</code></code> objects are derived from <code><code>IO::File</code></code> and that all the <code><code>IO::Uncompress::*</code></code> modules can read from an <code><code>IO::File</code></code> filehandle.</p>

<p>So, for example, say you have a file compressed with gzip that you want to recompress with bzip2. Here is all that is needed to carry out the recompression.</p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">IO::Uncompress::Gunzip</span> <span class="string">':all'</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">IO::Compress::Bzip2</span> <span class="string">':all'</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$gzipFile</span> <span class="operator">=</span> <span class="string">"somefile.gz"</span><span class="operator">;</span>
    <span class="keyword">my</span> <span class="variable">$bzipFile</span> <span class="operator">=</span> <span class="string">"somefile.bz2"</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$gunzip</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Uncompress::Gunzip</span> <span class="variable">$gzipFile</span>
        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot gunzip </span><span class="variable">$gzipFile</span><span class="string">: </span><span class="variable">$GunzipError</span><span class="string">\n"</span> <span class="operator">;</span>
    
    <span class="variable">bzip2</span> <span class="variable">$gunzip</span> <span class="operator">=&gt;</span> <span class="variable">$bzipFile</span> 
        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot bzip2 to </span><span class="variable">$bzipFile</span><span class="string">: </span><span class="variable">$Bzip2Error</span><span class="string">\n"</span> <span class="operator">;</span>
</code></code></pre>

<p>Note, there is a limitation of this technique. Some compression file formats store extra information along with the compressed data payload. For example, gzip can optionally store the original filename and Zip stores a lot of information about the original file. If the original compressed file contains any of this extra information, it will not be transferred to the new compressed file usign the technique above.</p>

<h1 id="ZIP">ZIP</h1>

<h2 id="What-Compression-Types-do-IO::Compress::Zip-IO::Uncompress::Unzip-support-">What Compression Types do IO::Compress::Zip &amp; IO::Uncompress::Unzip support?</h2>

<p>The following compression formats are supported by <code><code>IO::Compress::Zip</code></code> and <code><code>IO::Uncompress::Unzip</code></code></p>

<ul>

<li><p>Store (method 0)</p>

<p>No compression at all.</p>

</li>
<li><p>Deflate (method 8)</p>

<p>This is the default compression used when creating a zip file with <code><code>IO::Compress::Zip</code></code>.</p>

</li>
<li><p>Bzip2 (method 12)</p>

<p>Only supported if the <code><code>IO-Compress-Bzip2</code></code> module is installed.</p>

</li>
<li><p>Lzma (method 14)</p>

<p>Only supported if the <code><code>IO-Compress-Lzma</code></code> module is installed.</p>

</li>
</ul>

<h2 id="Can-I-Read-Write-Zip-files-larger-the-4-Gig-">Can I Read/Write Zip files larger the 4 Gig?</h2>

<p>Yes, both the <code><code>IO-Compress-Zip</code></code> and <code><code>IO-Uncompress-Unzip</code></code> modules support the zip feature called <i>Zip64</i>. That allows them to read/write files/buffers larger than 4Gig.</p>

<p>If you are creating a Zip file using the one-shot interface, and any of the input files is greater than 4Gig, a zip64 complaint zip file will be created.</p>

<pre><code><code>    <span class="variable">zip</span> <span class="string">"really-large-file"</span> <span class="operator">=&gt;</span> <span class="string">"my.zip"</span><span class="operator">;</span>
</code></code></pre>

<p>Similarly with the one-shot interface, if the input is a buffer larger than 4 Gig, a zip64 complaint zip file will be created.</p>

<pre><code><code>    <span class="variable">zip</span> <span class="operator">\</span><span class="variable">$really_large_buffer</span> <span class="operator">=&gt;</span> <span class="string">"my.zip"</span><span class="operator">;</span>
</code></code></pre>

<p>The one-shot interface allows you to force the creation of a zip64 zip file by including the <code><code>Zip64</code></code> option.</p>

<pre><code><code>    <span class="variable">zip</span> <span class="variable">$filehandle</span> <span class="operator">=&gt;</span> <span class="string">"my.zip"</span><span class="operator">,</span> <span class="string">Zip64</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">;</span>
</code></code></pre>

<p>If you want to create a zip64 zip file with the OO interface you must specify the <code><code>Zip64</code></code> option.</p>

<pre><code><code>    <span class="keyword">my</span> <span class="variable">$zip</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Compress::Zip</span> <span class="string">"whatever"</span><span class="operator">,</span> <span class="string">Zip64</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">;</span>
        
</code></code></pre>

<p>When uncompressing with <code><code>IO-Uncompress-Unzip</code></code>, it will automatically detect if the zip file is zip64.</p>

<p>If you intend to manipulate the Zip64 zip files created with <code><code>IO-Compress-Zip</code></code> using an external zip/unzip, make sure that it supports Zip64.</p>

<p>In particular, if you are using Info-Zip you need to have zip version 3.x or better to update a Zip64 archive and unzip version 6.x to read a zip64 archive.</p>

<h2 id="Can-I-write-more-that-64K-entries-is-a-Zip-files-">Can I write more that 64K entries is a Zip files?</h2>

<p>Yes. Zip64 allows this. See previous question.</p>

<h2 id="Zip-Resources">Zip Resources</h2>

<p>The primary reference for zip files is the &quot;appnote&quot; document available at <a href="http://www.pkware.com/documents/casestudies/APPNOTE.TXT">http://www.pkware.com/documents/casestudies/APPNOTE.TXT</a></p>

<p>An alternatively is the Info-Zip appnote. This is available from <a href="ftp://ftp.info-zip.org/pub/infozip/doc/">ftp://ftp.info-zip.org/pub/infozip/doc/</a></p>

<h1 id="GZIP">GZIP</h1>

<h2 id="Gzip-Resources">Gzip Resources</h2>

<p>The primary reference for gzip files is RFC 1952 <a href="http://www.faqs.org/rfcs/rfc1952.html">http://www.faqs.org/rfcs/rfc1952.html</a></p>

<p>The primary site for gzip is <i>http://www.gzip.org</i>.</p>

<h2 id="Dealing-with-Concatenated-gzip-files">Dealing with Concatenated gzip files</h2>

<p>If the gunzip program encounters a file containing multiple gzip files concatenated together it will automatically uncompress them all. The example below illustrates this behaviour</p>

<pre><code><code>    $ echo abc | gzip -c &gt;x.gz
    $ echo def | gzip -c &gt;&gt;x.gz
    $ gunzip -c x.gz 
    abc
    def</code></code></pre>

<p>By default <code><code>IO::Uncompress::Gunzip</code></code> will <i>not</i> bahave like the gunzip program. It will only uncompress the first gzip data stream in the file, as shown below</p>

<pre><code><code>    $ perl -MIO::Uncompress::Gunzip=:all -e &#39;gunzip &quot;x.gz&quot; =&gt; \*STDOUT&#39;
    abc</code></code></pre>

<p>To force <code><code>IO::Uncompress::Gunzip</code></code> to uncompress all the gzip data streams, include the <code><code>MultiStream</code></code> option, as shown below</p>

<pre><code><code>    $ perl -MIO::Uncompress::Gunzip=:all -e &#39;gunzip &quot;x.gz&quot; =&gt; \*STDOUT, MultiStream =&gt; 1&#39;
    abc
    def</code></code></pre>

<h1 id="ZLIB">ZLIB</h1>

<h2 id="Zlib-Resources">Zlib Resources</h2>

<p>The primary site for the <i>zlib</i> compression library is <i>http://www.zlib.org</i>.</p>

<h1 id="Bzip2">Bzip2</h1>

<h2 id="Bzip2-Resources">Bzip2 Resources</h2>

<p>The primary site for bzip2 is <i>http://www.bzip.org</i>.</p>

<h2 id="Dealing-with-Concatenated-bzip2-files">Dealing with Concatenated bzip2 files</h2>

<p>If the bunzip2 program encounters a file containing multiple bzip2 files concatenated together it will automatically uncompress them all. The example below illustrates this behaviour</p>

<pre><code><code>    $ echo abc | bzip2 -c &gt;x.bz2
    $ echo def | bzip2 -c &gt;&gt;x.bz2
    $ bunzip2 -c x.bz2
    abc
    def</code></code></pre>

<p>By default <code><code>IO::Uncompress::Bunzip2</code></code> will <i>not</i> bahave like the bunzip2 program. It will only uncompress the first bunzip2 data stream in the file, as shown below</p>

<pre><code><code>    $ perl -MIO::Uncompress::Bunzip2=:all -e &#39;bunzip2 &quot;x.bz2&quot; =&gt; \*STDOUT&#39;
    abc</code></code></pre>

<p>To force <code><code>IO::Uncompress::Bunzip2</code></code> to uncompress all the bzip2 data streams, include the <code><code>MultiStream</code></code> option, as shown below</p>

<pre><code><code>    $ perl -MIO::Uncompress::Bunzip2=:all -e &#39;bunzip2 &quot;x.bz2&quot; =&gt; \*STDOUT, MultiStream =&gt; 1&#39;
    abc
    def</code></code></pre>

<h2 id="Interoperating-with-Pbzip2">Interoperating with Pbzip2</h2>

<p>Pbzip2 (<a href="http://compression.ca/pbzip2/">http://compression.ca/pbzip2/</a>) is a parallel implementation of bzip2. The output from pbzip2 consists of a series of concatenated bzip2 data streams.</p>

<p>By default <code><code>IO::Uncompress::Bzip2</code></code> will only uncompress the first bzip2 data stream in a pbzip2 file. To uncompress the complete pbzip2 file you must include the <code><code>MultiStream</code></code> option, like this.</p>

<pre><code><code>    <span class="variable">bunzip2</span> <span class="variable">$input</span> <span class="operator">=&gt;</span> <span class="operator">\</span><span class="variable">$output</span><span class="operator">,</span> <span class="string">MultiStream</span> <span class="operator">=&gt;</span> <span class="number">1</span> 
        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"bunzip2 failed: </span><span class="variable">$Bunzip2Error</span><span class="string">\n"</span><span class="operator">;</span>
</code></code></pre>

<h1 id="HTTP-NETWORK">HTTP &amp; NETWORK</h1>

<h2 id="Apache::GZip-Revisited">Apache::GZip Revisited</h2>

<p>Below is a mod_perl Apache compression module, called <code><code>Apache::GZip</code></code>, taken from <i>http://perl.apache.org/docs/tutorials/tips/mod_perl_tricks/mod_perl_tricks.html#On_the_Fly_Compression</i></p>

<pre><code><code>  <span class="keyword">package</span> <span class="variable">Apache::GZip</span><span class="operator">;</span>
  <span class="comment">#File: Apache::GZip.pm</span>
  
  <span class="keyword">use</span> <span class="variable">strict</span> <span class="variable">vars</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Apache::Constants</span> <span class="string">':common'</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Compress::Zlib</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">IO::File</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">constant</span> <span class="string">GZIP_MAGIC</span> <span class="operator">=&gt;</span> <span class="number">0x1f8b</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">constant</span> <span class="string">OS_MAGIC</span> <span class="operator">=&gt;</span> <span class="number">0x03</span><span class="operator">;</span>
  
  <span class="keyword">sub</span><span class="variable"> handler </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$r</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
      <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$fh</span><span class="operator">,</span><span class="variable">$gz</span><span class="operator">);</span>
      <span class="keyword">my</span> <span class="variable">$file</span> <span class="operator">=</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">filename</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">DECLINED</span> <span class="keyword">unless</span> <span class="variable">$fh</span><span class="operator">=</span><span class="variable">IO::File</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="variable">$file</span><span class="operator">);</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_out</span><span class="operator">(</span><span class="string">'Content-Encoding'</span><span class="operator">=&gt;</span><span class="string">'gzip'</span><span class="operator">);</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">send_http_header</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">OK</span> <span class="keyword">if</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_only</span><span class="operator">;</span>
  
      <span class="keyword">tie</span> <span class="variable">*STDOUT</span><span class="operator">,</span><span class="string">'Apache::GZip'</span><span class="operator">,</span><span class="variable">$r</span><span class="operator">;</span>
      <span class="keyword">print</span><span class="operator">(</span><span class="variable">$_</span><span class="operator">)</span> <span class="keyword">while</span> <span class="operator">&lt;</span><span class="variable">$fh</span><span class="operator">&gt;;</span>
      <span class="keyword">untie</span> <span class="variable">*STDOUT</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">OK</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="keyword">sub</span><span class="variable"> TIEHANDLE </span><span class="operator">{</span>
      <span class="keyword">my</span><span class="operator">(</span><span class="variable">$class</span><span class="operator">,</span><span class="variable">$r</span><span class="operator">)</span> <span class="operator">=</span> <span class="variable">@_</span><span class="operator">;</span>
      <span class="comment"># initialize a deflation stream</span>
      <span class="keyword">my</span> <span class="variable">$d</span> <span class="operator">=</span> <span class="variable">deflateInit</span><span class="operator">(</span><span class="string">-WindowBits</span><span class="operator">=&gt;-</span><span class="variable">MAX_WBITS</span><span class="operator">())</span> <span class="operator">||</span> <span class="keyword">return</span> <span class="keyword">undef</span><span class="operator">;</span>
  
      <span class="comment"># gzip header -- don't ask how I found out</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">print</span><span class="operator">(</span><span class="keyword">pack</span><span class="operator">(</span><span class="string">"nccVcc"</span><span class="operator">,</span><span class="variable">GZIP_MAGIC</span><span class="operator">,</span><span class="variable">Z_DEFLATED</span><span class="operator">,</span><span class="number">0</span><span class="operator">,</span><span class="keyword">time</span><span class="operator">(),</span><span class="number">0</span><span class="operator">,</span><span class="variable">OS_MAGIC</span><span class="operator">));</span>
  
      <span class="keyword">return</span> <span class="keyword">bless</span> <span class="operator">{</span> <span class="string">r</span>   <span class="operator">=&gt;</span> <span class="variable">$r</span><span class="operator">,</span>
                     <span class="string">crc</span> <span class="operator">=&gt;</span>  <span class="variable">crc32</span><span class="operator">(</span><span class="keyword">undef</span><span class="operator">),</span>
                     <span class="string">d</span>   <span class="operator">=&gt;</span> <span class="variable">$d</span><span class="operator">,</span>
                     <span class="string">l</span>   <span class="operator">=&gt;</span>  <span class="number">0</span> 
                   <span class="operator">}</span><span class="operator">,</span><span class="variable">$class</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="keyword">sub</span><span class="variable"> PRINT </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$self</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
      <span class="keyword">foreach</span> <span class="operator">(</span><span class="variable">@_</span><span class="operator">)</span> <span class="operator">{</span>
        <span class="comment"># deflate the data</span>
        <span class="keyword">my</span> <span class="variable">$data</span> <span class="operator">=</span> <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">d</span><span class="operator">}</span><span class="operator">-&gt;</span><span class="variable">deflate</span><span class="operator">(</span><span class="variable">$_</span><span class="operator">);</span>
        <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">r</span><span class="operator">}</span><span class="operator">-&gt;</span><span class="variable">print</span><span class="operator">(</span><span class="variable">$data</span><span class="operator">);</span>
        <span class="comment"># keep track of its length and crc</span>
        <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">l</span><span class="operator">}</span> <span class="operator">+=</span> <span class="keyword">length</span><span class="operator">(</span><span class="variable">$_</span><span class="operator">);</span>
        <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">crc</span><span class="operator">}</span> <span class="operator">=</span> <span class="variable">crc32</span><span class="operator">(</span><span class="variable">$_</span><span class="operator">,</span><span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">crc</span><span class="operator">}</span><span class="operator">);</span>
      <span class="operator">}</span>
  <span class="operator">}</span>
  
  <span class="keyword">sub</span><span class="variable"> DESTROY </span><span class="operator">{</span>
     <span class="keyword">my</span> <span class="variable">$self</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
     
     <span class="comment"># flush the output buffers</span>
     <span class="keyword">my</span> <span class="variable">$data</span> <span class="operator">=</span> <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">d</span><span class="operator">}</span><span class="operator">-&gt;</span><span class="variable">flush</span><span class="operator">;</span>
     <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">r</span><span class="operator">}</span><span class="operator">-&gt;</span><span class="variable">print</span><span class="operator">(</span><span class="variable">$data</span><span class="operator">);</span>
     
     <span class="comment"># print the CRC and the total length (uncompressed)</span>
     <span class="variable">$self</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">r</span><span class="operator">}</span><span class="operator">-&gt;</span><span class="variable">print</span><span class="operator">(</span><span class="keyword">pack</span><span class="operator">(</span><span class="string">"LL"</span><span class="operator">,</span><span class="variable">@</span><span class="operator">{</span><span class="variable">$self</span><span class="operator">}{</span><span class="string">qw/crc l/</span><span class="operator">}</span><span class="operator">));</span>
  <span class="operator">}</span>
   
  <span class="number">1</span><span class="operator">;</span>
</code></code></pre>

<p>Here&#39;s the Apache configuration entry you&#39;ll need to make use of it. Once set it will result in everything in the /compressed directory will be compressed automagically.</p>

<pre><code><code>  &lt;Location /compressed&gt;
     SetHandler  perl-script
     PerlHandler Apache::GZip
  &lt;/Location&gt;</code></code></pre>

<p>Although at first sight there seems to be quite a lot going on in <code><code>Apache::GZip</code></code>, you could sum up what the code was doing as follows -- read the contents of the file in <code><code>$r-&gt;filename</code></code>, compress it and write the compressed data to standard output. That&#39;s all.</p>

<p>This code has to jump through a few hoops to achieve this because</p>

<ol>

<li><p>The gzip support in <code><code>Compress::Zlib</code></code> version 1.x can only work with a real filesystem filehandle. The filehandles used by Apache modules are not associated with the filesystem.</p>

</li>
<li><p>That means all the gzip support has to be done by hand - in this case by creating a tied filehandle to deal with creating the gzip header and trailer.</p>

</li>
</ol>

<p><code><code>IO::Compress::Gzip</code></code> doesn&#39;t have that filehandle limitation (this was one of the reasons for writing it in the first place). So if <code><code>IO::Compress::Gzip</code></code> is used instead of <code><code>Compress::Zlib</code></code> the whole tied filehandle code can be removed. Here is the rewritten code.</p>

<pre><code><code>  <span class="keyword">package</span> <span class="variable">Apache::GZip</span><span class="operator">;</span>
  
  <span class="keyword">use</span> <span class="variable">strict</span> <span class="variable">vars</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Apache::Constants</span> <span class="string">':common'</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">IO::Compress::Gzip</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">IO::File</span><span class="operator">;</span>
  
  <span class="keyword">sub</span><span class="variable"> handler </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$r</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
      <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$fh</span><span class="operator">,</span><span class="variable">$gz</span><span class="operator">);</span>
      <span class="keyword">my</span> <span class="variable">$file</span> <span class="operator">=</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">filename</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">DECLINED</span> <span class="keyword">unless</span> <span class="variable">$fh</span><span class="operator">=</span><span class="variable">IO::File</span><span class="operator">-&gt;</span><span class="variable">new</span><span class="operator">(</span><span class="variable">$file</span><span class="operator">);</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_out</span><span class="operator">(</span><span class="string">'Content-Encoding'</span><span class="operator">=&gt;</span><span class="string">'gzip'</span><span class="operator">);</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">send_http_header</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">OK</span> <span class="keyword">if</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_only</span><span class="operator">;</span>
  
      <span class="keyword">my</span> <span class="variable">$gz</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Compress::Gzip</span> <span class="string">'-'</span><span class="operator">,</span> <span class="string">Minimal</span> <span class="operator">=&gt;</span> <span class="number">1</span>
          <span class="keyword">or</span> <span class="keyword">return</span> <span class="variable">DECLINED</span> <span class="operator">;</span>
  
      <span class="keyword">print</span> <span class="variable">$gz</span> <span class="variable">$_</span> <span class="keyword">while</span> <span class="operator">&lt;</span><span class="variable">$fh</span><span class="operator">&gt;;</span>
  
      <span class="keyword">return</span> <span class="variable">OK</span><span class="operator">;</span>
  <span class="operator">}</span>
</code></code></pre>

<p>or even more succinctly, like this, using a one-shot gzip</p>

<pre><code><code>  <span class="keyword">package</span> <span class="variable">Apache::GZip</span><span class="operator">;</span>
  
  <span class="keyword">use</span> <span class="variable">strict</span> <span class="variable">vars</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">Apache::Constants</span> <span class="string">':common'</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">IO::Compress::Gzip</span> <span class="string">qw(gzip)</span><span class="operator">;</span>
  
  <span class="keyword">sub</span><span class="variable"> handler </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$r</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_out</span><span class="operator">(</span><span class="string">'Content-Encoding'</span><span class="operator">=&gt;</span><span class="string">'gzip'</span><span class="operator">);</span>
      <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">send_http_header</span><span class="operator">;</span>
      <span class="keyword">return</span> <span class="variable">OK</span> <span class="keyword">if</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">header_only</span><span class="operator">;</span>
  
      <span class="variable">gzip</span> <span class="variable">$r</span><span class="operator">-&gt;</span><span class="variable">filename</span> <span class="operator">=&gt;</span> <span class="string">'-'</span><span class="operator">,</span> <span class="string">Minimal</span> <span class="operator">=&gt;</span> <span class="number">1</span>
        <span class="keyword">or</span> <span class="keyword">return</span> <span class="variable">DECLINED</span> <span class="operator">;</span>
  
      <span class="keyword">return</span> <span class="variable">OK</span><span class="operator">;</span>
  <span class="operator">}</span>
   
  <span class="number">1</span><span class="operator">;</span>
</code></code></pre>

<p>The use of one-shot <code><code>gzip</code></code> above just reads from <code><code>$r-&gt;filename</code></code> and writes the compressed data to standard output.</p>

<p>Note the use of the <code><code>Minimal</code></code> option in the code above. When using gzip for Content-Encoding you should <i>always</i> use this option. In the example above it will prevent the filename being included in the gzip header and make the size of the gzip data stream a slight bit smaller.</p>

<h2 id="Compressed-files-and-Net::FTP">Compressed files and Net::FTP</h2>

<p>The <code><code>Net::FTP</code></code> module provides two low-level methods called <code><code>stor</code></code> and <code><code>retr</code></code> that both return filehandles. These filehandles can used with the <code><code>IO::Compress/Uncompress</code></code> modules to compress or uncompress files read from or written to an FTP Server on the fly, without having to create a temporary file.</p>

<p>Firstly, here is code that uses <code><code>retr</code></code> to uncompressed a file as it is read from the FTP Server.</p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">Net::FTP</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">IO::Uncompress::Gunzip</span> <span class="string">qw(:all)</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$ftp</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">Net::FTP</span> <span class="operator">...</span>
    
    <span class="keyword">my</span> <span class="variable">$retr_fh</span> <span class="operator">=</span> <span class="variable">$ftp</span><span class="operator">-&gt;</span><span class="variable">retr</span><span class="operator">(</span><span class="variable">$compressed_filename</span><span class="operator">);</span>
    <span class="variable">gunzip</span> <span class="variable">$retr_fh</span> <span class="operator">=&gt;</span> <span class="variable">$outFilename</span><span class="operator">,</span> <span class="string">AutoClose</span> <span class="operator">=&gt;</span> <span class="number">1</span>
        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot uncompress '</span><span class="variable">$compressed_file</span><span class="string">': </span><span class="variable">$GunzipError</span><span class="string">\n"</span><span class="operator">;</span>
</code></code></pre>

<p>and this to compress a file as it is written to the FTP Server</p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">Net::FTP</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">IO::Compress::Gzip</span> <span class="string">qw(:all)</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$stor_fh</span> <span class="operator">=</span> <span class="variable">$ftp</span><span class="operator">-&gt;</span><span class="variable">stor</span><span class="operator">(</span><span class="variable">$filename</span><span class="operator">);</span>
    <span class="variable">gzip</span> <span class="string">"filename"</span> <span class="operator">=&gt;</span> <span class="variable">$stor_fh</span><span class="operator">,</span> <span class="string">AutoClose</span> <span class="operator">=&gt;</span> <span class="number">1</span>
        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot compress '</span><span class="variable">$filename</span><span class="string">': </span><span class="variable">$GzipError</span><span class="string">\n"</span><span class="operator">;</span>
</code></code></pre>

<h1 id="MISC">MISC</h1>

<h2 id="Using-to-uncompress-data-embedded-in-a-larger-file-buffer.">Using <code><code>InputLength</code></code> to uncompress data embedded in a larger file/buffer.</h2>

<p>A fairly common use-case is where compressed data is embedded in a larger file/buffer and you want to read both.</p>

<p>As an example consider the structure of a zip file. This is a well-defined file format that mixes both compressed and uncompressed sections of data in a single file.</p>

<p>For the purposes of this discussion you can think of a zip file as sequence of compressed data streams, each of which is prefixed by an uncompressed local header. The local header contains information about the compressed data stream, including the name of the compressed file and, in particular, the length of the compressed data stream.</p>

<p>To illustrate how to use <code><code>InputLength</code></code> here is a script that walks a zip file and prints out how many lines are in each compressed file (if you intend write code to walking through a zip file for real see <a href="../../../lib/IO/Uncompress/Unzip.html#Walking-through-a-zip-file">&quot;Walking through a zip file&quot; in IO::Uncompress::Unzip</a> ). Also, although this example uses the zlib-based compression, the technique can be used by the other <code><code>IO::Uncompress::*</code></code> modules.</p>

<pre><code><code>    <span class="keyword">use</span> <span class="variable">strict</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">warnings</span><span class="operator">;</span>
    
    <span class="keyword">use</span> <span class="variable">IO::File</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">IO::Uncompress::RawInflate</span> <span class="string">qw(:all)</span><span class="operator">;</span>
    
    <span class="keyword">use</span> <span class="variable">constant</span> <span class="string">ZIP_LOCAL_HDR_SIG</span>  <span class="operator">=&gt;</span> <span class="number">0x04034b50</span><span class="operator">;</span>
    <span class="keyword">use</span> <span class="variable">constant</span> <span class="string">ZIP_LOCAL_HDR_LENGTH</span> <span class="operator">=&gt;</span> <span class="number">30</span><span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$file</span> <span class="operator">=</span> <span class="variable">$ARGV</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span> <span class="operator">;</span>
    
    <span class="keyword">my</span> <span class="variable">$fh</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::File</span> <span class="string">"&lt;</span><span class="variable">$file</span><span class="string">"</span>
                <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot open '</span><span class="variable">$file</span><span class="string">': $!\n"</span><span class="operator">;</span>
    
    <span class="keyword">while</span> <span class="operator">(</span><span class="number">1</span><span class="operator">)</span>
    <span class="operator">{</span>
        <span class="keyword">my</span> <span class="variable">$sig</span><span class="operator">;</span>
        <span class="keyword">my</span> <span class="variable">$buffer</span><span class="operator">;</span>
    
        <span class="keyword">my</span> <span class="variable">$x</span> <span class="operator">;</span>
        <span class="operator">(</span><span class="variable">$x</span> <span class="operator">=</span> <span class="variable">$fh</span><span class="operator">-&gt;</span><span class="variable">read</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="variable">ZIP_LOCAL_HDR_LENGTH</span><span class="operator">))</span> <span class="operator">==</span> <span class="variable">ZIP_LOCAL_HDR_LENGTH</span> 
            <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Truncated file: $!\n"</span><span class="operator">;</span>
    
        <span class="keyword">my</span> <span class="variable">$signature</span> <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"V"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="number">4</span><span class="operator">));</span>
    
        <span class="keyword">last</span> <span class="keyword">unless</span> <span class="variable">$signature</span> <span class="operator">==</span> <span class="variable">ZIP_LOCAL_HDR_SIG</span><span class="operator">;</span>
    
        <span class="comment"># Read Local Header</span>
        <span class="keyword">my</span> <span class="variable">$gpFlag</span>             <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"v"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">6</span><span class="operator">,</span> <span class="number">2</span><span class="operator">));</span>
        <span class="keyword">my</span> <span class="variable">$compressedMethod</span>   <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"v"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">8</span><span class="operator">,</span> <span class="number">2</span><span class="operator">));</span>
        <span class="keyword">my</span> <span class="variable">$compressedLength</span>   <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"V"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">18</span><span class="operator">,</span> <span class="number">4</span><span class="operator">));</span>
        <span class="keyword">my</span> <span class="variable">$uncompressedLength</span> <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"V"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">22</span><span class="operator">,</span> <span class="number">4</span><span class="operator">));</span>
        <span class="keyword">my</span> <span class="variable">$filename_length</span>    <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"v"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">26</span><span class="operator">,</span> <span class="number">2</span><span class="operator">));</span> 
        <span class="keyword">my</span> <span class="variable">$extra_length</span>       <span class="operator">=</span> <span class="keyword">unpack</span> <span class="operator">(</span><span class="string">"v"</span><span class="operator">,</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="number">28</span><span class="operator">,</span> <span class="number">2</span><span class="operator">));</span>
    
        <span class="keyword">my</span> <span class="variable">$filename</span> <span class="operator">;</span>
        <span class="variable">$fh</span><span class="operator">-&gt;</span><span class="variable">read</span><span class="operator">(</span><span class="variable">$filename</span><span class="operator">,</span> <span class="variable">$filename_length</span><span class="operator">)</span> <span class="operator">==</span> <span class="variable">$filename_length</span> 
            <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Truncated file\n"</span><span class="operator">;</span>
    
        <span class="variable">$fh</span><span class="operator">-&gt;</span><span class="variable">read</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="variable">$extra_length</span><span class="operator">)</span> <span class="operator">==</span> <span class="variable">$extra_length</span>
            <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Truncated file\n"</span><span class="operator">;</span>
    
        <span class="keyword">if</span> <span class="operator">(</span><span class="variable">$compressedMethod</span> <span class="operator">!=</span> <span class="number">8</span> <span class="operator">&amp;&amp;</span> <span class="variable">$compressedMethod</span> <span class="operator">!=</span> <span class="number">0</span><span class="operator">)</span>
        <span class="operator">{</span>
            <span class="keyword">warn</span> <span class="string">"Skipping file '</span><span class="variable">$filename</span><span class="string">' - not deflated </span><span class="variable">$compressedMethod</span><span class="string">\n"</span><span class="operator">;</span>
            <span class="variable">$fh</span><span class="operator">-&gt;</span><span class="variable">read</span><span class="operator">(</span><span class="variable">$buffer</span><span class="operator">,</span> <span class="variable">$compressedLength</span><span class="operator">)</span> <span class="operator">==</span> <span class="variable">$compressedLength</span>
                <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Truncated file\n"</span><span class="operator">;</span>
            <span class="keyword">next</span><span class="operator">;</span>
        <span class="operator">}</span>
    
        <span class="keyword">if</span> <span class="operator">(</span><span class="variable">$compressedMethod</span> <span class="operator">==</span> <span class="number">0</span> <span class="operator">&amp;&amp;</span> <span class="variable">$gpFlag</span> <span class="operator">&amp;</span> <span class="number">8</span> <span class="operator">==</span> <span class="number">8</span><span class="operator">)</span>
        <span class="operator">{</span>
            <span class="keyword">die</span> <span class="string">"Streamed Stored not supported for '</span><span class="variable">$filename</span><span class="string">'\n"</span><span class="operator">;</span>
        <span class="operator">}</span>
    
        <span class="keyword">next</span> <span class="keyword">if</span> <span class="variable">$compressedLength</span> <span class="operator">==</span> <span class="number">0</span><span class="operator">;</span>
    
        <span class="comment"># Done reading the Local Header</span>
    
        <span class="keyword">my</span> <span class="variable">$inf</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Uncompress::RawInflate</span> <span class="variable">$fh</span><span class="operator">,</span>
                            <span class="string">Transparent</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
                            <span class="string">InputLength</span> <span class="operator">=&gt;</span> <span class="variable">$compressedLength</span>
          <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot uncompress </span><span class="variable">$file</span><span class="string"> [</span><span class="variable">$filename</span><span class="string">]: </span><span class="variable">$RawInflateError</span><span class="string">\n"</span>  <span class="operator">;</span>
    
        <span class="keyword">my</span> <span class="variable">$line_count</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
    
        <span class="keyword">while</span> <span class="operator">(&lt;</span><span class="variable">$inf</span><span class="operator">&gt;)</span>
        <span class="operator">{</span>
            <span class="operator">++</span> <span class="variable">$line_count</span><span class="operator">;</span>
        <span class="operator">}</span>
    
        <span class="keyword">print</span> <span class="string">"</span><span class="variable">$filename</span><span class="string">: </span><span class="variable">$line_count</span><span class="string">\n"</span><span class="operator">;</span>
    <span class="operator">}</span>
</code></code></pre>

<p>The majority of the code above is concerned with reading the zip local header data. The code that I want to focus on is at the bottom.</p>

<pre><code><code>    <span class="keyword">while</span> <span class="operator">(</span><span class="number">1</span><span class="operator">)</span> <span class="operator">{</span>
    
        <span class="comment"># read local zip header data</span>
        <span class="comment"># get $filename</span>
        <span class="comment"># get $compressedLength</span>
    
        <span class="keyword">my</span> <span class="variable">$inf</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Uncompress::RawInflate</span> <span class="variable">$fh</span><span class="operator">,</span>
                            <span class="string">Transparent</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
                            <span class="string">InputLength</span> <span class="operator">=&gt;</span> <span class="variable">$compressedLength</span>
          <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot uncompress </span><span class="variable">$file</span><span class="string"> [</span><span class="variable">$filename</span><span class="string">]: </span><span class="variable">$RawInflateError</span><span class="string">\n"</span>  <span class="operator">;</span>
    
        <span class="keyword">my</span> <span class="variable">$line_count</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
    
        <span class="keyword">while</span> <span class="operator">(&lt;</span><span class="variable">$inf</span><span class="operator">&gt;)</span>
        <span class="operator">{</span>
            <span class="operator">++</span> <span class="variable">$line_count</span><span class="operator">;</span>
        <span class="operator">}</span>
    
        <span class="keyword">print</span> <span class="string">"</span><span class="variable">$filename</span><span class="string">: </span><span class="variable">$line_count</span><span class="string">\n"</span><span class="operator">;</span>
    <span class="operator">}</span>
</code></code></pre>

<p>The call to <code><code>IO::Uncompress::RawInflate</code></code> creates a new filehandle <code><code>$inf</code></code> that can be used to read from the parent filehandle <code><code>$fh</code></code>, uncompressing it as it goes. The use of the <code><code>InputLength</code></code> option will guarantee that <i>at most</i> <code><code>$compressedLength</code></code> bytes of compressed data will be read from the <code><code>$fh</code></code> filehandle (The only exception is for an error case like a truncated file or a corrupt data stream).</p>

<p>This means that once RawInflate is finished <code><code>$fh</code></code> will be left at the byte directly after the compressed data stream.</p>

<p>Now consider what the code looks like without <code><code>InputLength</code></code></p>

<pre><code><code>    <span class="keyword">while</span> <span class="operator">(</span><span class="number">1</span><span class="operator">)</span> <span class="operator">{</span>
    
        <span class="comment"># read local zip header data</span>
        <span class="comment"># get $filename</span>
        <span class="comment"># get $compressedLength</span>
    
        <span class="comment"># read all the compressed data into $data</span>
        <span class="keyword">read</span><span class="operator">(</span><span class="variable">$fh</span><span class="operator">,</span> <span class="variable">$data</span><span class="operator">,</span> <span class="variable">$compressedLength</span><span class="operator">);</span>
    
        <span class="keyword">my</span> <span class="variable">$inf</span> <span class="operator">=</span> <span class="variable">new</span> <span class="variable">IO::Uncompress::RawInflate</span> <span class="operator">\</span><span class="variable">$data</span><span class="operator">,</span>
                            <span class="string">Transparent</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
          <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot uncompress </span><span class="variable">$file</span><span class="string"> [</span><span class="variable">$filename</span><span class="string">]: </span><span class="variable">$RawInflateError</span><span class="string">\n"</span>  <span class="operator">;</span>
    
        <span class="keyword">my</span> <span class="variable">$line_count</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
    
        <span class="keyword">while</span> <span class="operator">(&lt;</span><span class="variable">$inf</span><span class="operator">&gt;)</span>
        <span class="operator">{</span>
            <span class="operator">++</span> <span class="variable">$line_count</span><span class="operator">;</span>
        <span class="operator">}</span>
    
        <span class="keyword">print</span> <span class="string">"</span><span class="variable">$filename</span><span class="string">: </span><span class="variable">$line_count</span><span class="string">\n"</span><span class="operator">;</span>
    <span class="operator">}</span>
</code></code></pre>

<p>The difference here is the addition of the temporary variable <code><code>$data</code></code>. This is used to store a copy of the compressed data while it is being uncompressed.</p>

<p>If you know that <code><code>$compressedLength</code></code> isn&#39;t that big then using temporary storage won&#39;t be a problem. But if <code><code>$compressedLength</code></code> is very large or you are writing an application that other people will use, and so have no idea how big <code><code>$compressedLength</code></code> will be, it could be an issue.</p>

<p>Using <code><code>InputLength</code></code> avoids the use of temporary storage and means the application can cope with large compressed data streams.</p>

<p>One final point -- obviously <code><code>InputLength</code></code> can only be used whenever you know the length of the compressed data beforehand, like here with a zip file.</p>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<p><a href="../../../lib/Compress/Zlib.html">Compress::Zlib</a>, <a href="../../../lib/IO/Compress/Gzip.html">IO::Compress::Gzip</a>, <a href="../../../lib/IO/Uncompress/Gunzip.html">IO::Uncompress::Gunzip</a>, <a href="../../../lib/IO/Compress/Deflate.html">IO::Compress::Deflate</a>, <a href="../../../lib/IO/Uncompress/Inflate.html">IO::Uncompress::Inflate</a>, <a href="../../../lib/IO/Compress/RawDeflate.html">IO::Compress::RawDeflate</a>, <a href="../../../lib/IO/Uncompress/RawInflate.html">IO::Uncompress::RawInflate</a>, <a href="../../../lib/IO/Compress/Bzip2.html">IO::Compress::Bzip2</a>, <a href="../../../lib/IO/Uncompress/Bunzip2.html">IO::Uncompress::Bunzip2</a>, <a>IO::Compress::Lzma</a>, <a>IO::Uncompress::UnLzma</a>, <a>IO::Compress::Xz</a>, <a>IO::Uncompress::UnXz</a>, <a>IO::Compress::Lzop</a>, <a>IO::Uncompress::UnLzop</a>, <a>IO::Compress::Lzf</a>, <a>IO::Uncompress::UnLzf</a>, <a href="../../../lib/IO/Uncompress/AnyInflate.html">IO::Uncompress::AnyInflate</a>, <a href="../../../lib/IO/Uncompress/AnyUncompress.html">IO::Uncompress::AnyUncompress</a></p>

<p><a href="../../../lib/IO/Compress/FAQ.html">IO::Compress::FAQ</a></p>

<p><a href="../../../lib/File/GlobMapper.html">File::GlobMapper</a>, <a href="../../../lib/Archive/Zip.html">Archive::Zip</a>, <a href="../../../lib/Archive/Tar.html">Archive::Tar</a>, <a href="../../../lib/IO/Zlib.html">IO::Zlib</a></p>

<h1 id="AUTHOR">AUTHOR</h1>

<p>This module was written by Paul Marquess, <i>pmqs@cpan.org</i>.</p>

<h1 id="MODIFICATION-HISTORY">MODIFICATION HISTORY</h1>

<p>See the Changes file.</p>

<h1 id="COPYRIGHT-AND-LICENSE">COPYRIGHT AND LICENSE</h1>

<p>Copyright (c) 2005-2012 Paul Marquess. All rights reserved.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>


</body>

</html>


