<?xml version="1.0" ?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<!-- saved from url=(0017)http://localhost/ -->
<script language="JavaScript" src="../../displayToc.js"></script>
<script language="JavaScript" src="../../tocParas.js"></script>
<script language="JavaScript" src="../../tocTab.js"></script>
<link rel="stylesheet" type="text/css" href="../../scineplex.css">
<title></title>
<link rel="stylesheet" href="../../Active.css" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a></li>
  <li><a href="#NOTABLE-DIFFERENCES-FROM-OTHER-DRIVERS">NOTABLE DIFFERENCES FROM OTHER DRIVERS</a>
    <ul>
      <li><a href="#Database-Name-Is-A-File-Name">Database Name Is A File Name</a></li>
      <li><a href="#Accessing-A-Database-With-Other-Tools">Accessing A Database With Other Tools</a></li>
      <li><a href="#Blobs">Blobs</a></li>
      <li><a href="#Functions-And-Bind-Parameters">Functions And Bind Parameters</a></li>
      <li><a href="#Placeholders">Placeholders</a></li>
      <li><a href="#Foreign-Keys">Foreign Keys</a></li>
      <li><a href="#Pragma">Pragma</a></li>
      <li><a href="#Transactions">Transactions</a></li>
      <li><a href="#Transaction-and-Database-Locking">Transaction and Database Locking</a></li>
      <li><a href="#and-Transaction-Rollback"> and Transaction Rollback</a></li>
      <li><a href="#Processing-Multiple-Statements-At-A-Time">Processing Multiple Statements At A Time</a></li>
      <li><a href="#Performance">Performance</a></li>
    </ul>
  </li>
  <li><a href="#DRIVER-PRIVATE-ATTRIBUTES">DRIVER PRIVATE ATTRIBUTES</a>
    <ul>
      <li><a href="#Database-Handle-Attributes">Database Handle Attributes</a></li>
      <li><a href="#Statement-Handle-Attributes">Statement Handle Attributes</a></li>
    </ul>
  </li>
  <li><a href="#METHODS">METHODS</a>
    <ul>
      <li><a href="#table_info">table_info</a></li>
      <li><a href="#primary_key-primary_key_info">primary_key, primary_key_info</a></li>
    </ul>
  </li>
  <li><a href="#DRIVER-PRIVATE-METHODS">DRIVER PRIVATE METHODS</a>
    <ul>
      <li><a href="#dbh-sqlite_last_insert_rowid-">$dbh-&gt;sqlite_last_insert_rowid()</a></li>
      <li><a href="#dbh-sqlite_busy_timeout-">$dbh-&gt;sqlite_busy_timeout()</a></li>
      <li><a href="#dbh-sqlite_busy_timeout-ms-">$dbh-&gt;sqlite_busy_timeout( $ms )</a></li>
      <li><a href="#dbh-sqlite_create_function-name-argc-code_ref-">$dbh-&gt;sqlite_create_function( $name, $argc, $code_ref )</a>
        <ul>
          <li><a href="#REGEXP-function">REGEXP function</a></li>
        </ul>
      </li>
      <li><a href="#dbh-sqlite_create_collation-name-code_ref-">$dbh-&gt;sqlite_create_collation( $name, $code_ref )</a></li>
      <li><a href="#dbh-sqlite_collation_needed-code_ref-">$dbh-&gt;sqlite_collation_needed( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_create_aggregate-name-argc-pkg-">$dbh-&gt;sqlite_create_aggregate( $name, $argc, $pkg )</a></li>
      <li><a href="#dbh-sqlite_progress_handler-n_opcodes-code_ref-">$dbh-&gt;sqlite_progress_handler( $n_opcodes, $code_ref )</a></li>
      <li><a href="#dbh-sqlite_commit_hook-code_ref-">$dbh-&gt;sqlite_commit_hook( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_rollback_hook-code_ref-">$dbh-&gt;sqlite_rollback_hook( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_update_hook-code_ref-">$dbh-&gt;sqlite_update_hook( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_set_authorizer-code_ref-">$dbh-&gt;sqlite_set_authorizer( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_backup_from_file-filename-">$dbh-&gt;sqlite_backup_from_file( $filename )</a></li>
      <li><a href="#dbh-sqlite_backup_to_file-filename-">$dbh-&gt;sqlite_backup_to_file( $filename )</a></li>
      <li><a href="#dbh-sqlite_enable_load_extension-bool-">$dbh-&gt;sqlite_enable_load_extension( $bool )</a></li>
      <li><a href="#dbh-sqlite_trace-code_ref-">$dbh-&gt;sqlite_trace( $code_ref )</a></li>
      <li><a href="#dbh-sqlite_profile-code_ref-">$dbh-&gt;sqlite_profile( $code_ref )</a></li>
      <li><a href="#DBD::SQLite::compile_options-">DBD::SQLite::compile_options()</a></li>
    </ul>
  </li>
  <li><a href="#DRIVER-CONSTANTS">DRIVER CONSTANTS</a>
    <ul>
      <li><a href="#Authorizer-Return-Codes">Authorizer Return Codes</a></li>
      <li><a href="#Action-Codes">Action Codes</a></li>
    </ul>
  </li>
  <li><a href="#COLLATION-FUNCTIONS">COLLATION FUNCTIONS</a>
    <ul>
      <li><a href="#Definition">Definition</a></li>
      <li><a href="#Builtin-collation-sequences">Builtin collation sequences</a></li>
      <li><a href="#Usage">Usage</a></li>
      <li><a href="#Unicode-handling">Unicode handling</a></li>
      <li><a href="#Adding-user-defined-collations">Adding user-defined collations</a></li>
    </ul>
  </li>
  <li><a href="#FULLTEXT-SEARCH">FULLTEXT SEARCH</a>
    <ul>
      <li><a href="#Short-introduction-to-FTS3">Short introduction to FTS3</a></li>
      <li><a href="#Tokenizers">Tokenizers</a>
        <ul>
          <li><a href="#SQLite-builtin-tokenizers">SQLite builtin tokenizers</a></li>
          <li><a href="#Perl-tokenizers">Perl tokenizers</a></li>
        </ul>
      </li>
      <li><a href="#Incomplete-handling-of-utf8-characters">Incomplete handling of utf8 characters</a></li>
      <li><a href="#Database-space-for-FTS3">Database space for FTS3</a></li>
    </ul>
  </li>
  <li><a href="#R-TREE-SUPPORT">R* TREE SUPPORT</a></li>
  <li><a href="#FOR-DBD::SQLITE-EXTENSION-AUTHORS">FOR DBD::SQLITE EXTENSION AUTHORS</a></li>
  <li><a href="#TO-DO">TO DO</a>
    <ul>
      <li><a href="#Leak-Detection">Leak Detection</a></li>
      <li><a href="#Stream-API-for-Blobs">Stream API for Blobs</a></li>
      <li><a href="#Flags-for-sqlite3_open_v2">Flags for sqlite3_open_v2</a></li>
      <li><a href="#Support-for-custom-callbacks-for-R-Tree-queries">Support for custom callbacks for R-Tree queries</a></li>
    </ul>
  </li>
  <li><a href="#SUPPORT">SUPPORT</a></li>
  <li><a href="#AUTHORS">AUTHORS</a></li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>DBD::SQLite - Self-contained RDBMS in a DBI Driver</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBI</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">"dbi:SQLite:dbname=</span><span class="variable">$dbfile</span><span class="string">"</span><span class="operator">,</span><span class="string">""</span><span class="operator">,</span><span class="string">""</span><span class="operator">);</span>
</code></code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>SQLite is a public domain file-based relational database engine that you can find at <a href="http://www.sqlite.org/">http://www.sqlite.org/</a>.</p>

<p><b>DBD::SQLite</b> is a Perl DBI driver for SQLite, that includes the entire thing in the distribution. So in order to get a fast transaction capable RDBMS working for your perl project you simply have to install this module, and <b>nothing</b> else.</p>

<p>SQLite supports the following features:</p>

<dl>

<dt id="Implements-a-large-subset-of-SQL92">Implements a large subset of SQL92</dt>
<dd>

<p>See <a href="http://www.sqlite.org/lang.html">http://www.sqlite.org/lang.html</a> for details.</p>

</dd>
<dt id="A-complete-DB-in-a-single-disk-file">A complete DB in a single disk file</dt>
<dd>

<p>Everything for your database is stored in a single disk file, making it easier to move things around than with <a href="../../lib/DBD/CSV.html">DBD::CSV</a>.</p>

</dd>
<dt id="Atomic-commit-and-rollback">Atomic commit and rollback</dt>
<dd>

<p>Yes, <b>DBD::SQLite</b> is small and light, but it supports full transactions!</p>

</dd>
<dt id="Extensible">Extensible</dt>
<dd>

<p>User-defined aggregate or regular functions can be registered with the SQL parser.</p>

</dd>
</dl>

<p>There&#39;s lots more to it, so please refer to the docs on the SQLite web page, listed above, for SQL details. Also refer to <a href="../../lib/DBI.html">DBI</a> for details on how to use DBI itself. The API works like every DBI module does. However, currently many statement attributes are not implemented or are limited by the typeless nature of the SQLite database.</p>

<h1 id="NOTABLE-DIFFERENCES-FROM-OTHER-DRIVERS">NOTABLE DIFFERENCES FROM OTHER DRIVERS</h1>

<h2 id="Database-Name-Is-A-File-Name">Database Name Is A File Name</h2>

<p>SQLite creates a file per a database. You should pass the <code><code>path</code></code> of the database file (with or without a parent directory) in the DBI connection string (as a database <code><code>name</code></code>):</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">"dbi:SQLite:dbname=</span><span class="variable">$dbfile</span><span class="string">"</span><span class="operator">,</span><span class="string">""</span><span class="operator">,</span><span class="string">""</span><span class="operator">);</span>
</code></code></pre>

<p>The file is opened in read/write mode, and will be created if it does not exist yet.</p>

<p>Although the database is stored in a single file, the directory containing the database file must be writable by SQLite because the library will create several temporary files there.</p>

<p>If the filename <code><code>$dbfile</code></code> is &quot;:memory:&quot;, then a private, temporary in-memory database is created for the connection. This in-memory database will vanish when the database connection is closed. It is handy for your library tests.</p>

<p>Note that future versions of SQLite might make use of additional special filenames that begin with the &quot;:&quot; character. It is recommended that when a database filename actually does begin with a &quot;:&quot; character you should prefix the filename with a pathname such as &quot;./&quot; to avoid ambiguity.</p>

<p>If the filename <code><code>$dbfile</code></code> is an empty string, then a private, temporary on-disk database will be created. This private database will be automatically deleted as soon as the database connection is closed.</p>

<h2 id="Accessing-A-Database-With-Other-Tools">Accessing A Database With Other Tools</h2>

<p>To access the database from the command line, try using <code><code>dbish</code></code> which comes with the <a>DBI::Shell</a> module. Just type:</p>

<pre><code><code>  dbish dbi:SQLite:foo.db</code></code></pre>

<p>On the command line to access the file <i>foo.db</i>.</p>

<p>Alternatively you can install SQLite from the link above without conflicting with <b>DBD::SQLite</b> and use the supplied <code><code>sqlite3</code></code> command line tool.</p>

<h2 id="Blobs">Blobs</h2>

<p>As of version 1.11, blobs should &quot;just work&quot; in SQLite as text columns. However this will cause the data to be treated as a string, so SQL statements such as length(x) will return the length of the column as a NUL terminated string, rather than the size of the blob in bytes. In order to store natively as a BLOB use the following code:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBI</span> <span class="string">qw(:sql_types)</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">"dbi:SQLite:dbfile"</span><span class="operator">,</span><span class="string">""</span><span class="operator">,</span><span class="string">""</span><span class="operator">);</span>
  
  <span class="keyword">my</span> <span class="variable">$blob</span> <span class="operator">=</span> <span class="string">`cat foo.jpg`</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"INSERT INTO mytable VALUES (1, ?)"</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">bind_param</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="variable">$blob</span><span class="operator">,</span> <span class="variable">SQL_BLOB</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">();</span>
</code></code></pre>

<p>And then retrieval just works:</p>

<pre><code><code>  <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"SELECT * FROM mytable WHERE id = 1"</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">();</span>
  <span class="keyword">my</span> <span class="variable">$row</span> <span class="operator">=</span> <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">fetch</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$blobo</span> <span class="operator">=</span> <span class="variable">$row</span><span class="operator">-&gt;</span><span class="operator">[</span><span class="number">1</span><span class="operator">]</span><span class="operator">;</span>
  
  <span class="comment"># now $blobo == $blob</span>
</code></code></pre>

<h2 id="Functions-And-Bind-Parameters">Functions And Bind Parameters</h2>

<p>As of this writing, a SQL that compares a return value of a function with a numeric bind value like this doesn&#39;t work as you might expect.</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">q{
    SELECT bar FROM foo GROUP BY bar HAVING count(*) &gt; ?;
  }</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">(</span><span class="number">5</span><span class="operator">);</span>
</code></code></pre>

<p>This is because DBD::SQLite assumes that all the bind values are text (and should be quoted) by default. Thus the above statement becomes like this while executing:</p>

<pre><code><code>  <span class="variable">SELECT</span> <span class="variable">bar</span> <span class="variable">FROM</span> <span class="variable">foo</span> <span class="variable">GROUP</span> <span class="variable">BY</span> <span class="variable">bar</span> <span class="variable">HAVING</span> <span class="variable">count</span><span class="operator">(*)</span> <span class="operator">&gt;</span> <span class="string">"5"</span><span class="operator">;</span>
</code></code></pre>

<p>There are three workarounds for this.</p>

<dl>

<dt id="Use-bind_param-explicitly">Use bind_param() explicitly</dt>
<dd>

<p>As shown above in the <code><code>BLOB</code></code> section, you can always use <code><code>bind_param()</code></code> to tell the type of a bind value.</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBI</span> <span class="string">qw(:sql_types)</span><span class="operator">;</span>  <span class="comment"># Don't forget this</span>
  
  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">q{
    SELECT bar FROM foo GROUP BY bar HAVING count(*) &gt; ?;
  }</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">bind_param</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="number">5</span><span class="operator">,</span> <span class="variable">SQL_INTEGER</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">();</span>
</code></code></pre>

</dd>
<dt id="Add-zero-to-make-it-a-number">Add zero to make it a number</dt>
<dd>

<p>This is somewhat weird, but works anyway.</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">q{
    SELECT bar FROM foo GROUP BY bar HAVING count(*) &gt; (? + 0);
  }</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">(</span><span class="number">5</span><span class="operator">);</span>
</code></code></pre>

</dd>
<dt id="Set-sqlite_see_if_its_a_number-database-handle-attribute">Set <code><code>sqlite_see_if_its_a_number</code></code> database handle attribute</dt>
<dd>

<p>As of version 1.32_02, you can use <code><code>sqlite_see_if_its_a_number</code></code> to let DBD::SQLite to see if the bind values are numbers or not.</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">sqlite_see_if_its_a_number</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">q{
    SELECT bar FROM foo GROUP BY bar HAVING count(*) &gt; ?;
  }</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">(</span><span class="number">5</span><span class="operator">);</span>
</code></code></pre>

<p>You can set it to true when you connect to a database.</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">'dbi:SQLite:foo'</span><span class="operator">,</span> <span class="keyword">undef</span><span class="operator">,</span> <span class="keyword">undef</span><span class="operator">,</span> <span class="operator">{</span>
    <span class="string">AutoCommit</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
    <span class="string">RaiseError</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
    <span class="string">sqlite_see_if_its_a_number</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
  <span class="operator">}</span><span class="operator">);</span>
</code></code></pre>

<p>This is the most straightforward solution, but as noted above, existing data in your databases created by DBD::SQLite have not always been stored as numbers, so this *might* cause other obscure problems. Use this sparingly when you handle existing databases. If you handle databases created by other tools like native <code><code>sqlite3</code></code> command line tool, this attribute would help you.</p>

</dd>
</dl>

<h2 id="Placeholders">Placeholders</h2>

<p>SQLite supports several placeholder expressions, including <code><code>?</code></code> and <code><code>:AAAA</code></code>. Consult the <a href="../../lib/DBI.html">DBI</a> and sqlite documentation for details.</p>

<p><a href="http://www.sqlite.org/lang_expr.html#varparam">http://www.sqlite.org/lang_expr.html#varparam</a></p>

<p>Note that a question mark actually means a next unused (numbered) placeholder. You&#39;re advised not to use it with other (numbered or named) placeholders to avoid confusion.</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span>
    <span class="string">'update TABLE set a=?1 where b=?2 and a IS NOT ?1'</span>
  <span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="number">2</span><span class="operator">);</span> 
</code></code></pre>

<h2 id="Foreign-Keys">Foreign Keys</h2>

<p><b>BE PREPARED! WOLVES APPROACH!!</b></p>

<p>SQLite has started supporting foreign key constraints since 3.6.19 (released on Oct 14, 2009; bundled in DBD::SQLite 1.26_05). To be exact, SQLite has long been able to parse a schema with foreign keys, but the constraints has not been enforced. Now you can issue a pragma actually to enable this feature and enforce the constraints.</p>

<p>To do this, issue the following pragma (see below), preferably as soon as you connect to a database and you&#39;re not in a transaction:</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">do</span><span class="operator">(</span><span class="string">"PRAGMA foreign_keys = ON"</span><span class="operator">);</span>
</code></code></pre>

<p>And you can explicitly disable the feature whenever you like by turning the pragma off:</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">do</span><span class="operator">(</span><span class="string">"PRAGMA foreign_keys = OFF"</span><span class="operator">);</span>
</code></code></pre>

<p>As of this writing, this feature is disabled by default by the sqlite team, and by us, to secure backward compatibility, as this feature may break your applications, and actually broke some for us. If you have used a schema with foreign key constraints but haven&#39;t cared them much and supposed they&#39;re always ignored for SQLite, be prepared, and <b>please do extensive testing to ensure that your applications will continue to work when the foreign keys support is enabled by default</b>. It is very likely that the sqlite team will turn it default-on in the future, and we plan to do it NO LATER THAN they do so.</p>

<p>See <a href="http://www.sqlite.org/foreignkeys.html">http://www.sqlite.org/foreignkeys.html</a> for details.</p>

<h2 id="Pragma">Pragma</h2>

<p>SQLite has a set of &quot;Pragma&quot;s to modifiy its operation or to query for its internal data. These are specific to SQLite and are not likely to work with other DBD libraries, but you may find some of these are quite useful. DBD::SQLite actually sets some (like <code><code>show_datatypes</code></code>) for you when you connect to a database. See <a href="http://www.sqlite.org/pragma.html">http://www.sqlite.org/pragma.html</a> for details.</p>

<h2 id="Transactions">Transactions</h2>

<p>DBI/DBD::SQLite&#39;s transactions may be a bit confusing. They behave differently according to the status of the <code><code>AutoCommit</code></code> flag:</p>

<dl>

<dt id="When-the-AutoCommit-flag-is-on">When the AutoCommit flag is on</dt>
<dd>

<p>You&#39;re supposed to always use the auto-commit mode, except you explicitly begin a transaction, and when the transaction ended, you&#39;re supposed to go back to the auto-commit mode. To begin a transaction, call <code><code>begin_work</code></code> method, or issue a <code><code>BEGIN</code></code> statement. To end it, call <code><code>commit/rollback</code></code> methods, or issue the corresponding statements.</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">AutoCommit</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
  
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">begin_work</span><span class="operator">;</span> <span class="comment"># or $dbh-&gt;do('BEGIN TRANSACTION');</span>
  
  <span class="comment"># $dbh-&gt;{AutoCommit} is turned off temporarily during a transaction;</span>
  
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">commit</span><span class="operator">;</span> <span class="comment"># or $dbh-&gt;do('COMMIT');</span>
  
  <span class="comment"># $dbh-&gt;{AutoCommit} is turned on again;</span>
</code></code></pre>

</dd>
<dt id="When-the-AutoCommit-flag-is-off">When the AutoCommit flag is off</dt>
<dd>

<p>You&#39;re supposed to always use the transactional mode, until you explicitly turn on the AutoCommit flag. You can explicitly issue a <code><code>BEGIN</code></code> statement (only when an actual transaction has not begun yet) but you&#39;re not allowed to call <code><code>begin_work</code></code> method (if you don&#39;t issue a <code><code>BEGIN</code></code>, it will be issued internally). You can commit or roll it back freely. Another transaction will automatically begins if you execute another statement.</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">AutoCommit</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
  
  <span class="comment"># $dbh-&gt;do('BEGIN TRANSACTION') is not necessary, but possible</span>
  
  <span class="operator">...</span>
  
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">commit</span><span class="operator">;</span> <span class="comment"># or $dbh-&gt;do('COMMIT');</span>
  
  <span class="comment"># $dbh-&gt;{AutoCommit} stays intact;</span>
  
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">AutoCommit</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>  <span class="comment"># ends the transactional mode</span>
</code></code></pre>

</dd>
</dl>

<p>This <code><code>AutoCommit</code></code> mode is independent from the autocommit mode of the internal SQLite library, which always begins by a <code><code>BEGIN</code></code> statement, and ends by a <code><code>COMMIT</code></code> or a &lt;ROLLBACK&gt;.</p>

<h2 id="Transaction-and-Database-Locking">Transaction and Database Locking</h2>

<p>Transaction by <code><code>AutoCommit</code></code> or <code><code>begin_work</code></code> is nice and handy, but sometimes you may get an annoying &quot;database is locked&quot; error. This typically happens when someone begins a transaction, and tries to write to a database while other person is reading from the database (in another transaction). You might be surprised but SQLite doesn&#39;t lock a database when you just begin a normal (deferred) transaction to maximize concurrency. It reserves a lock when you issue a statement to write, but until you actually try to write with a <code><code>commit</code></code> statement, it allows other people to read from the database. However, reading from the database also requires <code><code>shared lock</code></code>, and that prevents to give you the <code><code>exclusive lock</code></code> you reserved, thus you get the &quot;database is locked&quot; error, and other people will get the same error if they try to write afterwards, as you still have a <code><code>pending</code></code> lock. <code><code>busy_timeout</code></code> doesn&#39;t help in this case.</p>

<p>To avoid this, set a transaction type explicitly. You can issue a <code><code>begin immediate transaction</code></code> (or <code><code>begin exclusive transaction</code></code>) for each transaction, or set <code><code>sqlite_use_immediate_transaction</code></code> database handle attribute to true (since 1.30_02) to always use an immediate transaction (even when you simply use <code><code>begin_work</code></code> or turn off the <code><code>AutoCommit</code></code>.).</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">"dbi:SQLite::memory:"</span><span class="operator">,</span> <span class="string">""</span><span class="operator">,</span> <span class="string">""</span><span class="operator">,</span> <span class="operator">{</span>
    <span class="string">sqlite_use_immediate_transaction</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
  <span class="operator">}</span><span class="operator">);</span>
</code></code></pre>

<p>Note that this works only when all of the connections use the same (non-deferred) transaction. See <a href="http://sqlite.org/lockingv3.html">http://sqlite.org/lockingv3.html</a> for locking details.</p>

<h2 id="and-Transaction-Rollback"><code><code>$sth-&gt;finish</code></code> and Transaction Rollback</h2>

<p>As the <a href="../../lib/DBI.html">DBI</a> doc says, you almost certainly do <b>not</b> need to call <a href="../../lib/DBI.html#finish">&quot;finish&quot; in DBI</a> method if you fetch all rows (probably in a loop). However, there are several exceptions to this rule, and rolling-back of an unfinished <code><code>SELECT</code></code> statement is one of such exceptional cases.</p>

<p>SQLite prohibits <code><code>ROLLBACK</code></code> of unfinished <code><code>SELECT</code></code> statements in a transaction (See <a href="http://sqlite.org/lang_transaction.html">http://sqlite.org/lang_transaction.html</a> for details). So you need to call <code><code>finish</code></code> before you issue a rollback.</p>

<pre><code><code>  <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"SELECT * FROM t"</span><span class="operator">);</span>
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">begin_work</span><span class="operator">;</span>
  <span class="keyword">eval</span> <span class="operator">{</span>
      <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">;</span>
      <span class="variable">$row</span> <span class="operator">=</span> <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">fetch</span><span class="operator">;</span>
      <span class="operator">...</span>
      <span class="keyword">die</span> <span class="string">"For some reason"</span><span class="operator">;</span>
      <span class="operator">...</span>
  <span class="operator">};</span>
  <span class="keyword">if</span><span class="operator">(</span><span class="variable">$@</span><span class="operator">)</span> <span class="operator">{</span>
     <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">finish</span><span class="operator">;</span>  <span class="comment"># You need this for SQLite</span>
     <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">rollback</span><span class="operator">;</span>
  <span class="operator">}</span> <span class="keyword">else</span> <span class="operator">{</span>
     <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">commit</span><span class="operator">;</span>
  <span class="operator">}</span>
</code></code></pre>

<h2 id="Processing-Multiple-Statements-At-A-Time">Processing Multiple Statements At A Time</h2>

<p><a href="../../lib/DBI.html">DBI</a>&#39;s statement handle is not supposed to process multiple statements at a time. So if you pass a string that contains multiple statements (a <code><code>dump</code></code>) to a statement handle (via <code><code>prepare</code></code> or <code><code>do</code></code>), <a href="../../lib/DBD/SQLite.html">DBD::SQLite</a> only processes the first statement, and discards the rest.</p>

<p>Since 1.30_01, you can retrieve those ignored (unprepared) statements via <code><code><span class="variable">$sth</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">sqlite_unprepared_statements</span><span class="operator">}</span>
</code></code>. It usually contains nothing but white spaces, but if you really care, you can check this attribute to see if there&#39;s anything left undone. Also, if you set a <code><code>sqlite_allow_multiple_statements</code></code> attribute of a database handle to true when you connect to a database, <code><code>do</code></code> method automatically checks the <code><code>sqlite_unprepared_statements</code></code> attribute, and if it finds anything undone (even if what&#39;s left is just a single white space), it repeats the process again, to the end.</p>

<h2 id="Performance">Performance</h2>

<p>SQLite is fast, very fast. Matt processed his 72MB log file with it, inserting the data (400,000+ rows) by using transactions and only committing every 1000 rows (otherwise the insertion is quite slow), and then performing queries on the data.</p>

<p>Queries like count(*) and avg(bytes) took fractions of a second to return, but what surprised him most of all was:</p>

<pre><code><code>  SELECT url, count(*) as count
  FROM access_log
  GROUP BY url
  ORDER BY count desc
  LIMIT 20</code></code></pre>

<p>To discover the top 20 hit URLs on the site (<a href="http://axkit.org">http://axkit.org</a>), and it returned within 2 seconds. He was seriously considering switching his log analysis code to use this little speed demon!</p>

<p>Oh yeah, and that was with no indexes on the table, on a 400MHz PIII.</p>

<p>For best performance be sure to tune your hdparm settings if you are using linux. Also you might want to set:</p>

<pre><code><code>  PRAGMA synchronous = OFF</code></code></pre>

<p>Which will prevent sqlite from doing fsync&#39;s when writing (which slows down non-transactional writes significantly) at the expense of some peace of mind. Also try playing with the cache_size pragma.</p>

<p>The memory usage of SQLite can also be tuned using the cache_size pragma.</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">do</span><span class="operator">(</span><span class="string">"PRAGMA cache_size = 800000"</span><span class="operator">);</span>
</code></code></pre>

<p>The above will allocate 800M for DB cache; the default is 2M. Your sweet spot probably lies somewhere in between.</p>

<h1 id="DRIVER-PRIVATE-ATTRIBUTES">DRIVER PRIVATE ATTRIBUTES</h1>

<h2 id="Database-Handle-Attributes">Database Handle Attributes</h2>

<dl>

<dt id="sqlite_version">sqlite_version</dt>
<dd>

<p>Returns the version of the SQLite library which <b>DBD::SQLite</b> is using, e.g., &quot;2.8.0&quot;. Can only be read.</p>

</dd>
<dt id="sqlite_unicode">sqlite_unicode</dt>
<dd>

<p>If set to a true value, <b>DBD::SQLite</b> will turn the UTF-8 flag on for all text strings coming out of the database (this feature is currently disabled for perl &lt; 5.8.5). For more details on the UTF-8 flag see <a href="../../lib/pods/perlunicode.html">perlunicode</a>. The default is for the UTF-8 flag to be turned off.</p>

<p>Also note that due to some bizarreness in SQLite&#39;s type system (see <a href="http://www.sqlite.org/datatype3.html">http://www.sqlite.org/datatype3.html</a>), if you want to retain blob-style behavior for <b>some</b> columns under <code><code><span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">sqlite_unicode</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span>
</code></code> (say, to store images in the database), you have to state so explicitly using the 3-argument form of <a href="../../lib/DBI.html#bind_param">&quot;bind_param&quot; in DBI</a> when doing updates:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBI</span> <span class="string">qw(:sql_types)</span><span class="operator">;</span>
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">sqlite_unicode</span><span class="operator">}</span> <span class="operator">=</span> <span class="number">1</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"INSERT INTO mytable (blobcolumn) VALUES (?)"</span><span class="operator">);</span>
  
  <span class="comment"># Binary_data will be stored as is.</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">bind_param</span><span class="operator">(</span><span class="number">1</span><span class="operator">,</span> <span class="variable">$binary_data</span><span class="operator">,</span> <span class="variable">SQL_BLOB</span><span class="operator">);</span>
</code></code></pre>

<p>Defining the column type as <code><code>BLOB</code></code> in the DDL is <b>not</b> sufficient.</p>

<p>This attribute was originally named as <code><code>unicode</code></code>, and renamed to <code><code>sqlite_unicode</code></code> for integrity since version 1.26_06. Old <code><code>unicode</code></code> attribute is still accessible but will be deprecated in the near future.</p>

</dd>
<dt id="sqlite_allow_multiple_statements">sqlite_allow_multiple_statements</dt>
<dd>

<p>If you set this to true, <code><code>do</code></code> method will process multiple statements at one go. This may be handy, but with performance penalty. See above for details.</p>

</dd>
<dt id="sqlite_use_immediate_transaction">sqlite_use_immediate_transaction</dt>
<dd>

<p>If you set this to true, DBD::SQLite tries to issue a <code><code>begin immediate transaction</code></code> (instead of <code><code>begin transaction</code></code>) when necessary. See above for details.</p>

</dd>
<dt id="sqlite_see_if_its_a_number">sqlite_see_if_its_a_number</dt>
<dd>

<p>If you set this to true, DBD::SQLite tries to see if the bind values are number or not, and does not quote if they are numbers. See above for details.</p>

</dd>
</dl>

<h2 id="Statement-Handle-Attributes">Statement Handle Attributes</h2>

<dl>

<dt id="sqlite_unprepared_statements">sqlite_unprepared_statements</dt>
<dd>

<p>Returns an unprepared part of the statement you pass to <code><code>prepare</code></code>. Typically this contains nothing but white spaces after a semicolon. See above for details.</p>

</dd>
</dl>

<h1 id="METHODS">METHODS</h1>

<p>See also to the <a href="../../lib/DBI.html">DBI</a> documentation for the details of other common methods.</p>

<h2 id="table_info">table_info</h2>

<pre><code><code>  <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">table_info</span><span class="operator">(</span><span class="keyword">undef</span><span class="operator">,</span> <span class="variable">$schema</span><span class="operator">,</span> <span class="variable">$table</span><span class="operator">,</span> <span class="variable">$type</span><span class="operator">,</span> <span class="operator">\</span><span class="variable">%attr</span><span class="operator">);</span>
</code></code></pre>

<p>Returns all tables and schemas (databases) as specified in <a href="../../lib/DBI.html#table_info">&quot;table_info&quot; in DBI</a>. The schema and table arguments will do a <code><code>LIKE</code></code> search. You can specify an ESCAPE character by including an &#39;Escape&#39; attribute in \%attr. The <code><code>$type</code></code> argument accepts a comma separated list of the following types &#39;TABLE&#39;, &#39;VIEW&#39;, &#39;LOCAL TEMPORARY&#39; and &#39;SYSTEM TABLE&#39; (by default all are returned). Note that a statement handle is returned, and not a direct list of tables.</p>

<p>The following fields are returned:</p>

<p><b>TABLE_CAT</b>: Always NULL, as SQLite does not have the concept of catalogs.</p>

<p><b>TABLE_SCHEM</b>: The name of the schema (database) that the table or view is in. The default schema is &#39;main&#39;, temporary tables are in &#39;temp&#39; and other databases will be in the name given when the database was attached.</p>

<p><b>TABLE_NAME</b>: The name of the table or view.</p>

<p><b>TABLE_TYPE</b>: The type of object returned. Will be one of &#39;TABLE&#39;, &#39;VIEW&#39;, &#39;LOCAL TEMPORARY&#39; or &#39;SYSTEM TABLE&#39;.</p>

<h2 id="primary_key-primary_key_info">primary_key, primary_key_info</h2>

<pre><code><code>  <span class="variable">@names</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">primary_key</span><span class="operator">(</span><span class="keyword">undef</span><span class="operator">,</span> <span class="variable">$schema</span><span class="operator">,</span> <span class="variable">$table</span><span class="operator">);</span>
  <span class="variable">$sth</span>   <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">primary_key_info</span><span class="operator">(</span><span class="keyword">undef</span><span class="operator">,</span> <span class="variable">$schema</span><span class="operator">,</span> <span class="variable">$table</span><span class="operator">,</span> <span class="operator">\</span><span class="variable">%attr</span><span class="operator">);</span>
</code></code></pre>

<p>You can retrieve primary key names or more detailed information. As noted above, SQLite does not have the concept of catalogs, so the first argument of the mothods is usually <code><code>undef</code></code>, and you&#39;ll usually set <code><code>undef</code></code> for the second one (unless you want to know the primary keys of temporary tables).</p>

<h1 id="DRIVER-PRIVATE-METHODS">DRIVER PRIVATE METHODS</h1>

<p>The following methods can be called via the func() method with a little tweak, but the use of func() method is now discouraged by the <a href="../../lib/DBI.html">DBI</a> author for various reasons (see DBI&#39;s document <a href="http://search.cpan.org/dist/DBI/lib/DBI/DBD.pm#Using_install_method()_to_expose_driver-private_methods">http://search.cpan.org/dist/DBI/lib/DBI/DBD.pm#Using_install_method()_to_expose_driver-private_methods</a> for details). So, if you&#39;re using <a href="../../lib/DBI.html">DBI</a> &gt;= 1.608, use these <code><code>sqlite_</code></code> methods. If you need to use an older <a href="../../lib/DBI.html">DBI</a>, you can call these like this:</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">func</span><span class="operator">(</span> <span class="operator">...,</span> <span class="string">"(method name without sqlite_ prefix)"</span> <span class="operator">);</span>
</code></code></pre>

<p>Exception: <code><code>sqlite_trace</code></code> should always be called as is, even with <code><code>func()</code></code> method (to avoid conflict with DBI&#39;s trace() method).</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">func</span><span class="operator">(</span> <span class="operator">...,</span> <span class="string">"sqlite_trace"</span><span class="operator">);</span>
</code></code></pre>

<h2 id="dbh-sqlite_last_insert_rowid-">$dbh-&gt;sqlite_last_insert_rowid()</h2>

<p>This method returns the last inserted rowid. If you specify an INTEGER PRIMARY KEY as the first column in your table, that is the column that is returned. Otherwise, it is the hidden ROWID column. See the sqlite docs for details.</p>

<p>Generally you should not be using this method. Use the <a href="../../lib/DBI.html">DBI</a> last_insert_id method instead. The usage of this is:</p>

<pre><code><code>  $h-&gt;last_insert_id($catalog, $schema, $table_name, $field_name [, \%attr ])</code></code></pre>

<p>Running <code><code>$h-&gt;last_insert_id(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;)</code></code> is the equivalent of running <code><code>$dbh-&gt;sqlite_last_insert_rowid()</code></code> directly.</p>

<h2 id="dbh-sqlite_busy_timeout-">$dbh-&gt;sqlite_busy_timeout()</h2>

<p>Retrieve the current busy timeout.</p>

<h2 id="dbh-sqlite_busy_timeout-ms-">$dbh-&gt;sqlite_busy_timeout( $ms )</h2>

<p>Set the current busy timeout. The timeout is in milliseconds.</p>

<h2 id="dbh-sqlite_create_function-name-argc-code_ref-">$dbh-&gt;sqlite_create_function( $name, $argc, $code_ref )</h2>

<p>This method will register a new function which will be usable in an SQL query. The method&#39;s parameters are:</p>

<dl>

<dt id="name">$name</dt>
<dd>

<p>The name of the function. This is the name of the function as it will be used from SQL.</p>

</dd>
<dt id="argc">$argc</dt>
<dd>

<p>The number of arguments taken by the function. If this number is -1, the function can take any number of arguments.</p>

</dd>
<dt id="code_ref">$code_ref</dt>
<dd>

<p>This should be a reference to the function&#39;s implementation.</p>

</dd>
</dl>

<p>For example, here is how to define a now() function which returns the current number of seconds since the epoch:</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">sqlite_create_function</span><span class="operator">(</span> <span class="string">'now'</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span> <span class="keyword">return</span> <span class="keyword">time</span> <span class="operator">}</span> <span class="operator">);</span>
</code></code></pre>

<p>After this, it could be use from SQL as:</p>

<pre><code><code>  <span class="variable">INSERT</span> <span class="variable">INTO</span> <span class="variable">mytable</span> <span class="operator">(</span> <span class="variable">now</span><span class="operator">()</span> <span class="operator">);</span>
</code></code></pre>

<h3 id="REGEXP-function">REGEXP function</h3>

<p>SQLite includes syntactic support for an infix operator &#39;REGEXP&#39;, but without any implementation. The <code><code>DBD::SQLite</code></code> driver automatically registers an implementation that performs standard perl regular expression matching, using current locale. So for example you can search for words starting with an &#39;A&#39; with a query like</p>

<pre><code><code>  SELECT * from table WHERE column REGEXP &#39;\bA\w+&#39;</code></code></pre>

<p>If you want case-insensitive searching, use perl regex flags, like this :</p>

<pre><code><code>  SELECT * from table WHERE column REGEXP &#39;(?i:\bA\w+)&#39;</code></code></pre>

<p>The default REGEXP implementation can be overridden through the <code><code>create_function</code></code> API described above.</p>

<p>Note that regexp matching will <b>not</b> use SQLite indices, but will iterate over all rows, so it could be quite costly in terms of performance.</p>

<h2 id="dbh-sqlite_create_collation-name-code_ref-">$dbh-&gt;sqlite_create_collation( $name, $code_ref )</h2>

<p>This method manually registers a new function which will be usable in an SQL query as a COLLATE option for sorting. Such functions can also be registered automatically on demand: see section <a href="#COLLATION-FUNCTIONS">&quot;COLLATION FUNCTIONS&quot;</a> below.</p>

<p>The method&#39;s parameters are:</p>

<dl>

<dt id="name1">$name</dt>
<dd>

<p>The name of the function exposed to SQL.</p>

</dd>
<dt id="code_ref1">$code_ref</dt>
<dd>

<p>Reference to the function&#39;s implementation. The driver will check that this is a proper sorting function.</p>

</dd>
</dl>

<h2 id="dbh-sqlite_collation_needed-code_ref-">$dbh-&gt;sqlite_collation_needed( $code_ref )</h2>

<p>This method manually registers a callback function that will be invoked whenever an undefined collation sequence is required from an SQL statement. The callback is invoked as</p>

<pre><code><code>  $code_ref-&gt;($dbh, $collation_name)</code></code></pre>

<p>and should register the desired collation using <a href="#sqlite_create_collation">&quot;sqlite_create_collation&quot;</a>.</p>

<p>An initial callback is already registered by <code><code>DBD::SQLite</code></code>, so for most common cases it will be simpler to just add your collation sequences in the <code><code>%DBD::SQLite::COLLATION</code></code> hash (see section <a href="#COLLATION-FUNCTIONS">&quot;COLLATION FUNCTIONS&quot;</a> below).</p>

<h2 id="dbh-sqlite_create_aggregate-name-argc-pkg-">$dbh-&gt;sqlite_create_aggregate( $name, $argc, $pkg )</h2>

<p>This method will register a new aggregate function which can then be used from SQL. The method&#39;s parameters are:</p>

<dl>

<dt id="name2">$name</dt>
<dd>

<p>The name of the aggregate function, this is the name under which the function will be available from SQL.</p>

</dd>
<dt id="argc1">$argc</dt>
<dd>

<p>This is an integer which tells the SQL parser how many arguments the function takes. If that number is -1, the function can take any number of arguments.</p>

</dd>
<dt id="pkg">$pkg</dt>
<dd>

<p>This is the package which implements the aggregator interface.</p>

</dd>
</dl>

<p>The aggregator interface consists of defining three methods:</p>

<dl>

<dt id="new-">new()</dt>
<dd>

<p>This method will be called once to create an object which should be used to aggregate the rows in a particular group. The step() and finalize() methods will be called upon the reference return by the method.</p>

</dd>
<dt id="step-_-">step(@_)</dt>
<dd>

<p>This method will be called once for each row in the aggregate.</p>

</dd>
<dt id="finalize-">finalize()</dt>
<dd>

<p>This method will be called once all rows in the aggregate were processed and it should return the aggregate function&#39;s result. When there is no rows in the aggregate, finalize() will be called right after new().</p>

</dd>
</dl>

<p>Here is a simple aggregate function which returns the variance (example adapted from pysqlite):</p>

<pre><code><code>  <span class="keyword">package</span> <span class="variable">variance</span><span class="operator">;</span>
  
  <span class="keyword">sub</span><span class="variable"> new </span><span class="operator">{</span> <span class="keyword">bless</span> <span class="operator">[]</span><span class="operator">,</span> <span class="keyword">shift</span><span class="operator">;</span> <span class="operator">}</span>
  
  <span class="keyword">sub</span><span class="variable"> step </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="operator">(</span> <span class="variable">$self</span><span class="operator">,</span> <span class="variable">$value</span> <span class="operator">)</span> <span class="operator">=</span> <span class="variable">@_</span><span class="operator">;</span>
  
      <span class="keyword">push</span> <span class="variable">@$self</span><span class="operator">,</span> <span class="variable">$value</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="keyword">sub</span><span class="variable"> finalize </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$self</span> <span class="operator">=</span> <span class="variable">$_</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">;</span>
  
      <span class="keyword">my</span> <span class="variable">$n</span> <span class="operator">=</span> <span class="variable">@$self</span><span class="operator">;</span>
  
      <span class="comment"># Variance is NULL unless there is more than one row</span>
      <span class="keyword">return</span> <span class="keyword">undef</span> <span class="keyword">unless</span> <span class="variable">$n</span> <span class="operator">||</span> <span class="variable">$n</span> <span class="operator">==</span> <span class="number">1</span><span class="operator">;</span>
  
      <span class="keyword">my</span> <span class="variable">$mu</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
      <span class="keyword">foreach</span> <span class="keyword">my</span> <span class="variable">$v</span> <span class="operator">(</span> <span class="variable">@$self</span> <span class="operator">)</span> <span class="operator">{</span>
          <span class="variable">$mu</span> <span class="operator">+=</span> <span class="variable">$v</span><span class="operator">;</span>
      <span class="operator">}</span>
      <span class="variable">$mu</span> <span class="operator">/=</span> <span class="variable">$n</span><span class="operator">;</span>
  
      <span class="keyword">my</span> <span class="variable">$sigma</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
      <span class="keyword">foreach</span> <span class="keyword">my</span> <span class="variable">$v</span> <span class="operator">(</span> <span class="variable">@$self</span> <span class="operator">)</span> <span class="operator">{</span>
          <span class="variable">$sigma</span> <span class="operator">+=</span> <span class="operator">(</span><span class="variable">$x</span> <span class="operator">-</span> <span class="variable">$mu</span><span class="operator">)**</span><span class="number">2</span><span class="operator">;</span>
      <span class="operator">}</span>
      <span class="variable">$sigma</span> <span class="operator">=</span> <span class="variable">$sigma</span> <span class="operator">/</span> <span class="operator">(</span><span class="variable">$n</span> <span class="operator">-</span> <span class="number">1</span><span class="operator">);</span>
  
      <span class="keyword">return</span> <span class="variable">$sigma</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">sqlite_create_aggregate</span><span class="operator">(</span> <span class="string">"variance"</span><span class="operator">,</span> <span class="number">1</span><span class="operator">,</span> <span class="string">'variance'</span> <span class="operator">);</span>
</code></code></pre>

<p>The aggregate function can then be used as:</p>

<pre><code><code>  <span class="variable">SELECT</span> <span class="variable">group_name</span><span class="operator">,</span> <span class="variable">variance</span><span class="operator">(</span><span class="variable">score</span><span class="operator">)</span>
  <span class="variable">FROM</span> <span class="variable">results</span>
  <span class="variable">GROUP</span> <span class="variable">BY</span> <span class="variable">group_name</span><span class="operator">;</span>
</code></code></pre>

<p>For more examples, see the <a href="../../lib/DBD/SQLite/Cookbook.html">DBD::SQLite::Cookbook</a>.</p>

<h2 id="dbh-sqlite_progress_handler-n_opcodes-code_ref-">$dbh-&gt;sqlite_progress_handler( $n_opcodes, $code_ref )</h2>

<p>This method registers a handler to be invoked periodically during long running calls to SQLite.</p>

<p>An example use for this interface is to keep a GUI updated during a large query. The parameters are:</p>

<dl>

<dt id="n_opcodes">$n_opcodes</dt>
<dd>

<p>The progress handler is invoked once for every <code><code>$n_opcodes</code></code> virtual machine opcodes in SQLite.</p>

</dd>
<dt id="code_ref2">$code_ref</dt>
<dd>

<p>Reference to the handler subroutine. If the progress handler returns non-zero, the SQLite operation is interrupted. This feature can be used to implement a &quot;Cancel&quot; button on a GUI dialog box.</p>

<p>Set this argument to <code><code>undef</code></code> if you want to unregister a previous progress handler.</p>

</dd>
</dl>

<h2 id="dbh-sqlite_commit_hook-code_ref-">$dbh-&gt;sqlite_commit_hook( $code_ref )</h2>

<p>This method registers a callback function to be invoked whenever a transaction is committed. Any callback set by a previous call to <code><code>sqlite_commit_hook</code></code> is overridden. A reference to the previous callback (if any) is returned. Registering an <code><code>undef</code></code> disables the callback.</p>

<p>When the commit hook callback returns zero, the commit operation is allowed to continue normally. If the callback returns non-zero, then the commit is converted into a rollback (in that case, any attempt to <i>explicitly</i> call <code><code>$dbh-&gt;rollback()</code></code> afterwards would yield an error).</p>

<h2 id="dbh-sqlite_rollback_hook-code_ref-">$dbh-&gt;sqlite_rollback_hook( $code_ref )</h2>

<p>This method registers a callback function to be invoked whenever a transaction is rolled back. Any callback set by a previous call to <code><code>sqlite_rollback_hook</code></code> is overridden. A reference to the previous callback (if any) is returned. Registering an <code><code>undef</code></code> disables the callback.</p>

<h2 id="dbh-sqlite_update_hook-code_ref-">$dbh-&gt;sqlite_update_hook( $code_ref )</h2>

<p>This method registers a callback function to be invoked whenever a row is updated, inserted or deleted. Any callback set by a previous call to <code><code>sqlite_update_hook</code></code> is overridden. A reference to the previous callback (if any) is returned. Registering an <code><code>undef</code></code> disables the callback.</p>

<p>The callback will be called as</p>

<pre><code><code>  $code_ref-&gt;($action_code, $database, $table, $rowid)</code></code></pre>

<p>where</p>

<dl>

<dt id="action_code">$action_code</dt>
<dd>

<p>is an integer equal to either <code><code>DBD::SQLite::INSERT</code></code>, <code><code>DBD::SQLite::DELETE</code></code> or <code><code>DBD::SQLite::UPDATE</code></code> (see <a href="#Action-Codes">&quot;Action Codes&quot;</a>);</p>

</dd>
<dt id="database">$database</dt>
<dd>

<p>is the name of the database containing the affected row;</p>

</dd>
<dt id="table">$table</dt>
<dd>

<p>is the name of the table containing the affected row;</p>

</dd>
<dt id="rowid">$rowid</dt>
<dd>

<p>is the unique 64-bit signed integer key of the affected row within that table.</p>

</dd>
</dl>

<h2 id="dbh-sqlite_set_authorizer-code_ref-">$dbh-&gt;sqlite_set_authorizer( $code_ref )</h2>

<p>This method registers an authorizer callback to be invoked whenever SQL statements are being compiled by the <a href="../../lib/DBI.html#prepare">&quot;prepare&quot; in DBI</a> method. The authorizer callback should return <code><code>DBD::SQLite::OK</code></code> to allow the action, <code><code>DBD::SQLite::IGNORE</code></code> to disallow the specific action but allow the SQL statement to continue to be compiled, or <code><code>DBD::SQLite::DENY</code></code> to cause the entire SQL statement to be rejected with an error. If the authorizer callback returns any other value, then then <code><code>prepare</code></code> call that triggered the authorizer will fail with an error message.</p>

<p>An authorizer is used when preparing SQL statements from an untrusted source, to ensure that the SQL statements do not try to access data they are not allowed to see, or that they do not try to execute malicious statements that damage the database. For example, an application may allow a user to enter arbitrary SQL queries for evaluation by a database. But the application does not want the user to be able to make arbitrary changes to the database. An authorizer could then be put in place while the user-entered SQL is being prepared that disallows everything except SELECT statements.</p>

<p>The callback will be called as</p>

<pre><code><code>  $code_ref-&gt;($action_code, $string1, $string2, $database, $trigger_or_view)</code></code></pre>

<p>where</p>

<dl>

<dt id="action_code1">$action_code</dt>
<dd>

<p>is an integer that specifies what action is being authorized (see <a href="#Action-Codes">&quot;Action Codes&quot;</a>).</p>

</dd>
<dt id="string1-string2">$string1, $string2</dt>
<dd>

<p>are strings that depend on the action code (see <a href="#Action-Codes">&quot;Action Codes&quot;</a>).</p>

</dd>
<dt id="database1">$database</dt>
<dd>

<p>is the name of the database (<code><code>main</code></code>, <code><code>temp</code></code>, etc.) if applicable.</p>

</dd>
<dt id="trigger_or_view">$trigger_or_view</dt>
<dd>

<p>is the name of the inner-most trigger or view that is responsible for the access attempt, or <code><code>undef</code></code> if this access attempt is directly from top-level SQL code.</p>

</dd>
</dl>

<h2 id="dbh-sqlite_backup_from_file-filename-">$dbh-&gt;sqlite_backup_from_file( $filename )</h2>

<p>This method accesses the SQLite Online Backup API, and will take a backup of the named database file, copying it to, and overwriting, your current database connection. This can be particularly handy if your current connection is to the special :memory: database, and you wish to populate it from an existing DB.</p>

<h2 id="dbh-sqlite_backup_to_file-filename-">$dbh-&gt;sqlite_backup_to_file( $filename )</h2>

<p>This method accesses the SQLite Online Backup API, and will take a backup of the currently connected database, and write it out to the named file.</p>

<h2 id="dbh-sqlite_enable_load_extension-bool-">$dbh-&gt;sqlite_enable_load_extension( $bool )</h2>

<p>Calling this method with a true value enables loading (external) sqlite3 extensions. After the call, you can load extensions like this:</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">sqlite_enable_load_extension</span><span class="operator">(</span><span class="number">1</span><span class="operator">);</span>
  <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"select load_extension('libsqlitefunctions.so')"</span><span class="operator">)</span>
  <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Cannot prepare: "</span> <span class="operator">.</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">errstr</span><span class="operator">();</span>
</code></code></pre>

<h2 id="dbh-sqlite_trace-code_ref-">$dbh-&gt;sqlite_trace( $code_ref )</h2>

<p>This method registers a trace callback to be invoked whenever SQL statements are being run.</p>

<p>The callback will be called as</p>

<pre><code><code>  $code_ref-&gt;($statement)</code></code></pre>

<p>where</p>

<dl>

<dt id="statement">$statement</dt>
<dd>

<p>is a UTF-8 rendering of the SQL statement text as the statement first begins executing.</p>

</dd>
</dl>

<p>Additional callbacks might occur as each triggered subprogram is entered. The callbacks for triggers contain a UTF-8 SQL comment that identifies the trigger.</p>

<p>See also <a href="../../lib/DBI.html#TRACING">&quot;TRACING&quot; in DBI</a> for better tracing options.</p>

<h2 id="dbh-sqlite_profile-code_ref-">$dbh-&gt;sqlite_profile( $code_ref )</h2>

<p>This method registers a profile callback to be invoked whenever a SQL statement finishes.</p>

<p>The callback will be called as</p>

<pre><code><code>  $code_ref-&gt;($statement, $elapsed_time)</code></code></pre>

<p>where</p>

<dl>

<dt id="statement1">$statement</dt>
<dd>

<p>is the original statement text (without bind parameters).</p>

</dd>
<dt id="elapsed_time">$elapsed_time</dt>
<dd>

<p>is an estimate of wall-clock time of how long that statement took to run (in milliseconds).</p>

</dd>
</dl>

<p>This method is considered experimental and is subject to change in future versions of SQLite.</p>

<p>See also <a href="../../lib/DBI/Profile.html">DBI::Profile</a> for better profiling options.</p>

<h2 id="DBD::SQLite::compile_options-">DBD::SQLite::compile_options()</h2>

<p>Returns an array of compile options (available since sqlite 3.6.23, bundled in DBD::SQLite 1.30_01), or an empty array if the bundled library is old or compiled with SQLITE_OMIT_COMPILEOPTION_DIAGS.</p>

<h1 id="DRIVER-CONSTANTS">DRIVER CONSTANTS</h1>

<p>A subset of SQLite C constants are made available to Perl, because they may be needed when writing hooks or authorizer callbacks. For accessing such constants, the <code><code>DBD::SQLite</code></code> module must be explicitly <code><code>use</code></code>d at compile time. For example, an authorizer that forbids any DELETE operation would be written as follows :</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBD::SQLite</span><span class="operator">;</span>
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">sqlite_set_authorizer</span><span class="operator">(</span><span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
    <span class="keyword">my</span> <span class="variable">$action_code</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
    <span class="keyword">return</span> <span class="variable">$action_code</span> <span class="operator">==</span> <span class="variable">DBD::SQLite::DELETE</span> <span class="operator">?</span> <span class="variable">DBD::SQLite::DENY</span>
                                               <span class="operator">:</span> <span class="variable">DBD::SQLite::OK</span><span class="operator">;</span>
  <span class="operator">});</span>
</code></code></pre>

<p>The list of constants implemented in <code><code>DBD::SQLite</code></code> is given below; more information can be found ad at <a href="http://www.sqlite.org/c3ref/constlist.html">http://www.sqlite.org/c3ref/constlist.html</a>.</p>

<h2 id="Authorizer-Return-Codes">Authorizer Return Codes</h2>

<pre><code><code>  OK
  DENY
  IGNORE</code></code></pre>

<h2 id="Action-Codes">Action Codes</h2>

<p>The <a href="#set_authorizer">&quot;set_authorizer&quot;</a> method registers a callback function that is invoked to authorize certain SQL statement actions. The first parameter to the callback is an integer code that specifies what action is being authorized. The second and third parameters to the callback are strings, the meaning of which varies according to the action code. Below is the list of action codes, together with their associated strings.</p>

<pre><code><code>  # constant              string1         string2
  # ========              =======         =======
  CREATE_INDEX            Index Name      Table Name
  CREATE_TABLE            Table Name      undef
  CREATE_TEMP_INDEX       Index Name      Table Name
  CREATE_TEMP_TABLE       Table Name      undef
  CREATE_TEMP_TRIGGER     Trigger Name    Table Name
  CREATE_TEMP_VIEW        View Name       undef
  CREATE_TRIGGER          Trigger Name    Table Name
  CREATE_VIEW             View Name       undef
  DELETE                  Table Name      undef
  DROP_INDEX              Index Name      Table Name
  DROP_TABLE              Table Name      undef
  DROP_TEMP_INDEX         Index Name      Table Name
  DROP_TEMP_TABLE         Table Name      undef
  DROP_TEMP_TRIGGER       Trigger Name    Table Name
  DROP_TEMP_VIEW          View Name       undef
  DROP_TRIGGER            Trigger Name    Table Name
  DROP_VIEW               View Name       undef
  INSERT                  Table Name      undef
  PRAGMA                  Pragma Name     1st arg or undef
  READ                    Table Name      Column Name
  SELECT                  undef           undef
  TRANSACTION             Operation       undef
  UPDATE                  Table Name      Column Name
  ATTACH                  Filename        undef
  DETACH                  Database Name   undef
  ALTER_TABLE             Database Name   Table Name
  REINDEX                 Index Name      undef
  ANALYZE                 Table Name      undef
  CREATE_VTABLE           Table Name      Module Name
  DROP_VTABLE             Table Name      Module Name
  FUNCTION                undef           Function Name
  SAVEPOINT               Operation       Savepoint Name</code></code></pre>

<h1 id="COLLATION-FUNCTIONS">COLLATION FUNCTIONS</h1>

<h2 id="Definition">Definition</h2>

<p>SQLite v3 provides the ability for users to supply arbitrary comparison functions, known as user-defined &quot;collation sequences&quot; or &quot;collating functions&quot;, to be used for comparing two text values. <a href="http://www.sqlite.org/datatype3.html#collation">http://www.sqlite.org/datatype3.html#collation</a> explains how collations are used in various SQL expressions.</p>

<h2 id="Builtin-collation-sequences">Builtin collation sequences</h2>

<p>The following collation sequences are builtin within SQLite :</p>

<dl>

<dt id="BINARY"><b>BINARY</b></dt>
<dd>

<p>Compares string data using memcmp(), regardless of text encoding.</p>

</dd>
<dt id="NOCASE"><b>NOCASE</b></dt>
<dd>

<p>The same as binary, except the 26 upper case characters of ASCII are folded to their lower case equivalents before the comparison is performed. Note that only ASCII characters are case folded. SQLite does not attempt to do full UTF case folding due to the size of the tables required.</p>

</dd>
<dt id="RTRIM"><b>RTRIM</b></dt>
<dd>

<p>The same as binary, except that trailing space characters are ignored.</p>

</dd>
</dl>

<p>In addition, <code><code>DBD::SQLite</code></code> automatically installs the following collation sequences :</p>

<dl>

<dt id="perl"><b>perl</b></dt>
<dd>

<p>corresponds to the Perl <code><code>cmp</code></code> operator</p>

</dd>
<dt id="perllocale"><b>perllocale</b></dt>
<dd>

<p>Perl <code><code>cmp</code></code> operator, in a context where <code><code>use locale</code></code> is activated.</p>

</dd>
</dl>

<h2 id="Usage">Usage</h2>

<p>You can write for example</p>

<pre><code><code>  CREATE TABLE foo(
      txt1 COLLATE perl,
      txt2 COLLATE perllocale,
      txt3 COLLATE nocase
  )</code></code></pre>

<p>or</p>

<pre><code><code>  SELECT * FROM foo ORDER BY name COLLATE perllocale</code></code></pre>

<h2 id="Unicode-handling">Unicode handling</h2>

<p>If the attribute <code><code><span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="operator">{</span><span class="string">sqlite_unicode</span><span class="operator">}</span>
</code></code> is set, strings coming from the database and passed to the collation function will be properly tagged with the utf8 flag; but this only works if the <code><code>sqlite_unicode</code></code> attribute is set <b>before</b> the first call to a perl collation sequence . The recommended way to activate unicode is to set the parameter at connection time :</p>

<pre><code><code>  <span class="keyword">my</span> <span class="variable">$dbh</span> <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span>
      <span class="string">"dbi:SQLite:dbname=foo"</span><span class="operator">,</span> <span class="string">""</span><span class="operator">,</span> <span class="string">""</span><span class="operator">,</span>
      <span class="operator">{</span>
          <span class="string">RaiseError</span>     <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
          <span class="string">sqlite_unicode</span> <span class="operator">=&gt;</span> <span class="number">1</span><span class="operator">,</span>
      <span class="operator">}</span>
  <span class="operator">);</span>
</code></code></pre>

<h2 id="Adding-user-defined-collations">Adding user-defined collations</h2>

<p>The native SQLite API for adding user-defined collations is exposed through methods <a href="#sqlite_create_collation">&quot;sqlite_create_collation&quot;</a> and <a href="#sqlite_collation_needed">&quot;sqlite_collation_needed&quot;</a>.</p>

<p>To avoid calling these functions every time a <code><code>$dbh</code></code> handle is created, <code><code>DBD::SQLite</code></code> offers a simpler interface through the <code><code>%DBD::SQLite::COLLATION</code></code> hash : just insert your own collation functions in that hash, and whenever an unknown collation name is encountered in SQL, the appropriate collation function will be loaded on demand from the hash. For example, here is a way to sort text values regardless of their accented characters :</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">DBD::SQLite</span><span class="operator">;</span>
  <span class="variable">$DBD::SQLite::COLLATION</span><span class="operator">{</span><span class="string">no_accents</span><span class="operator">}</span> <span class="operator">=</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
    <span class="keyword">my</span> <span class="operator">(</span> <span class="variable">$a</span><span class="operator">,</span> <span class="variable">$b</span> <span class="operator">)</span> <span class="operator">=</span> <span class="keyword">map</span> <span class="keyword">lc</span><span class="operator">,</span> <span class="variable">@_</span><span class="operator">;</span>
    <span class="regex">tr[]
      [aaaaaacdeeeeiiiinoooooouuuuy]</span> <span class="keyword">for</span> <span class="variable">$a</span><span class="operator">,</span> <span class="variable">$b</span><span class="operator">;</span>
    <span class="variable">$a</span> <span class="keyword">cmp</span> <span class="variable">$b</span><span class="operator">;</span>
  <span class="operator">};</span>
  <span class="keyword">my</span> <span class="variable">$dbh</span>  <span class="operator">=</span> <span class="variable">DBI</span><span class="operator">-&gt;</span><span class="variable">connect</span><span class="operator">(</span><span class="string">"dbi:SQLite:dbname=dbfile"</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$sql</span>  <span class="operator">=</span> <span class="string">"SELECT ... FROM ... ORDER BY ... COLLATE no_accents"</span><span class="operator">);</span>
  <span class="keyword">my</span> <span class="variable">$rows</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">selectall_arrayref</span><span class="operator">(</span><span class="variable">$sql</span><span class="operator">);</span>
</code></code></pre>

<p>The builtin <code><code>perl</code></code> or <code><code>perllocale</code></code> collations are predefined in that same hash.</p>

<p>The COLLATION hash is a global registry within the current process; hence there is a risk of undesired side-effects. Therefore, to prevent action at distance, the hash is implemented as a &quot;write-only&quot; hash, that will happily accept new entries, but will raise an exception if any attempt is made to override or delete a existing entry (including the builtin <code><code>perl</code></code> and <code><code>perllocale</code></code>).</p>

<p>If you really, really need to change or delete an entry, you can always grab the tied object underneath <code><code>%DBD::SQLite::COLLATION</code></code> --- but don&#39;t do that unless you really know what you are doing. Also observe that changes in the global hash will not modify existing collations in existing database handles: it will only affect new <i>requests</i> for collations. In other words, if you want to change the behaviour of a collation within an existing <code><code>$dbh</code></code>, you need to call the <a href="#create_collation">&quot;create_collation&quot;</a> method directly.</p>

<h1 id="FULLTEXT-SEARCH">FULLTEXT SEARCH</h1>

<p>The FTS3 extension module within SQLite allows users to create special tables with a built-in full-text index (hereafter &quot;FTS3 tables&quot;). The full-text index allows the user to efficiently query the database for all rows that contain one or more instances of a specified word (hereafter a &quot;token&quot;), even if the table contains many large documents.</p>

<h2 id="Short-introduction-to-FTS3">Short introduction to FTS3</h2>

<p>The detailed documentation for FTS3 can be found at <a href="http://www.sqlite.org/fts3.html">http://www.sqlite.org/fts3.html</a>. Here is a very short example :</p>

<pre><code><code>  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">do</span><span class="operator">(&lt;&lt;</span><span class="default">""</span><span class="operator">)</span> <span class="keyword">or</span> <span class="keyword">die</span> <span class="variable">DBI::errstr</span><span class="operator">;</span><span class="string">
  CREATE VIRTUAL TABLE fts_example USING fts3(content)
  </span>
  <span class="keyword">my</span> <span class="variable">$sth</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">prepare</span><span class="operator">(</span><span class="string">"INSERT INTO fts_example(content) VALUES (?))"</span><span class="operator">);</span>
  <span class="variable">$sth</span><span class="operator">-&gt;</span><span class="variable">execute</span><span class="operator">(</span><span class="variable">$_</span><span class="operator">)</span> <span class="keyword">foreach</span> <span class="variable">@docs_to_insert</span><span class="operator">;</span>
  
  <span class="keyword">my</span> <span class="variable">$results</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">selectall_arrayref</span><span class="operator">(&lt;&lt;</span><span class="default">""</span><span class="operator">);</span><span class="string">
  SELECT docid, snippet(content) FROM fts_example WHERE content MATCH 'foo'
  </span>
</code></code></pre>

<p>The key points in this example are :</p>

<ul>

<li><p>The syntax for creating FTS3 tables is</p>

<pre><code><code>  CREATE VIRTUAL TABLE &lt;table_name&gt; USING fts3(&lt;columns&gt;)</code></code></pre>

<p>where <code><code>&lt;columns&gt;</code></code> is a list of column names. Columns may be typed, but the type information is ignored. If no columns are specified, the default is a single column named <code><code>content</code></code>. In addition, FTS3 tables have an implicit column called <code><code>docid</code></code> (or also <code><code>rowid</code></code>) for numbering the stored documents.</p>

</li>
<li><p>Statements for inserting, updating or deleting records use the same syntax as for regular SQLite tables.</p>

</li>
<li><p>Full-text searches are specified with the <code><code>MATCH</code></code> operator, and an operand which may be a single word, a word prefix ending with &#39;*&#39;, a list of words, a &quot;phrase query&quot; in double quotes, or a boolean combination of the above.</p>

</li>
<li><p>The builtin function <code><code>snippet(...)</code></code> builds a formatted excerpt of the document text, where the words pertaining to the query are highlighted.</p>

</li>
</ul>

<p>There are many more details to building and searching FTS3 tables, so we strongly invite you to read the full documentation at at <a href="http://www.sqlite.org/fts3.html">http://www.sqlite.org/fts3.html</a>.</p>

<p><b>Incompatible change</b> : starting from version 1.31, <code><code>DBD::SQLite</code></code> uses the new, recommended &quot;Enhanced Query Syntax&quot; for binary set operators (AND, OR, NOT, possibly nested with parenthesis). Previous versions of <code><code>DBD::SQLite</code></code> used the &quot;Standard Query Syntax&quot; (see <a href="http://www.sqlite.org/fts3.html#section_3_2">http://www.sqlite.org/fts3.html#section_3_2</a>). Unfortunately this is a compilation switch, so it cannot be tuned at runtime; however, since FTS3 was never advertised in versions prior to 1.31, the change should be invisible to the vast majority of <code><code>DBD::SQLite</code></code> users. If, however, there are any applications that nevertheless were built using the &quot;Standard Query&quot; syntax, they have to be migrated, because the precedence of the <code><code>OR</code></code> operator has changed. Conversion from old to new syntax can be automated through <a>DBD::SQLite::FTS3Transitional</a>, published in a separate distribution.</p>

<h2 id="Tokenizers">Tokenizers</h2>

<p>The behaviour of full-text indexes strongly depends on how documents are split into <i>tokens</i>; therefore FTS3 table declarations can explicitly specify how to perform tokenization:</p>

<pre><code><code>  CREATE ... USING fts3(&lt;columns&gt;, tokenize=&lt;tokenizer&gt;)</code></code></pre>

<p>where <code><code>&lt;tokenizer&gt;</code></code> is a sequence of space-separated words that triggers a specific tokenizer, as explained below.</p>

<h3 id="SQLite-builtin-tokenizers">SQLite builtin tokenizers</h3>

<p>SQLite comes with three builtin tokenizers :</p>

<dl>

<dt id="simple">simple</dt>
<dd>

<p>Under the <i>simple</i> tokenizer, a term is a contiguous sequence of eligible characters, where eligible characters are all alphanumeric characters, the &quot;_&quot; character, and all characters with UTF codepoints greater than or equal to 128. All other characters are discarded when splitting a document into terms. They serve only to separate adjacent terms.</p>

<p>All uppercase characters within the ASCII range (UTF codepoints less than 128), are transformed to their lowercase equivalents as part of the tokenization process. Thus, full-text queries are case-insensitive when using the simple tokenizer.</p>

</dd>
<dt id="porter">porter</dt>
<dd>

<p>The <i>porter</i> tokenizer uses the same rules to separate the input document into terms, but as well as folding all terms to lower case it uses the Porter Stemming algorithm to reduce related English language words to a common root.</p>

</dd>
<dt id="icu">icu</dt>
<dd>

<p>If SQLite is compiled with the SQLITE_ENABLE_ICU pre-processor symbol defined, then there exists a built-in tokenizer named &quot;icu&quot; implemented using the ICU library, and taking an ICU locale identifier as argument (such as &quot;tr_TR&quot; for Turkish as used in Turkey, or &quot;en_AU&quot; for English as used in Australia). For example:</p>

<pre><code><code>  CREATE VIRTUAL TABLE thai_text USING fts3(text, tokenize=icu th_TH)</code></code></pre>

<p>The ICU tokenizer implementation is very simple. It splits the input text according to the ICU rules for finding word boundaries and discards any tokens that consist entirely of white-space. This may be suitable for some applications in some locales, but not all. If more complex processing is required, for example to implement stemming or discard punctuation, use the perl tokenizer as explained below.</p>

</dd>
</dl>

<h3 id="Perl-tokenizers">Perl tokenizers</h3>

<p>In addition to the builtin SQLite tokenizers, <code><code>DBD::SQLite</code></code> implements a <i>perl</i> tokenizer, that can hook to any tokenizing algorithm written in Perl. This is specified as follows :</p>

<pre><code><code>  CREATE ... USING fts3(&lt;columns&gt;, tokenize=perl &#39;&lt;perl_function&gt;&#39;)</code></code></pre>

<p>where <code><code>&lt;perl_function&gt;</code></code> is a fully qualified Perl function name (i.e. prefixed by the name of the package in which that function is declared). So for example if the function is <code><code>my_func</code></code> in the main program, write</p>

<pre><code><code>  CREATE ... USING fts3(&lt;columns&gt;, tokenize=perl &#39;main::my_func&#39;)</code></code></pre>

<p>That function should return a code reference that takes a string as single argument, and returns an iterator (another function), which returns a tuple <code><code>($term, $len, $start, $end, $index)</code></code> for each term. Here is a simple example that tokenizes on words according to the current perl locale</p>

<pre><code><code>  <span class="keyword">sub</span><span class="variable"> locale_tokenizer </span><span class="operator">{</span>
    <span class="keyword">return</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span>
      <span class="keyword">my</span> <span class="variable">$string</span> <span class="operator">=</span> <span class="keyword">shift</span><span class="operator">;</span>
  
      <span class="keyword">use</span> <span class="variable">locale</span><span class="operator">;</span>
      <span class="keyword">my</span> <span class="variable">$regex</span>      <span class="operator">=</span> <span class="string">qr/\w+/</span><span class="operator">;</span>
      <span class="keyword">my</span> <span class="variable">$term_index</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span>
  
      <span class="keyword">return</span> <span class="keyword">sub</span><span class="variable"> </span><span class="operator">{</span> <span class="comment"># closure</span>
        <span class="variable">$string</span> <span class="operator">=~</span> <span class="regex">/</span><span class="variable">$regex</span><span class="regex">/g</span> <span class="keyword">or</span> <span class="keyword">return</span><span class="operator">;</span> <span class="comment"># either match, or no more token</span>
        <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$start</span><span class="operator">,</span> <span class="variable">$end</span><span class="operator">)</span> <span class="operator">=</span> <span class="operator">(</span><span class="variable">$-</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">,</span> <span class="variable">$+</span><span class="operator">[</span><span class="number">0</span><span class="operator">]</span><span class="operator">);</span>
        <span class="keyword">my</span> <span class="variable">$len</span>           <span class="operator">=</span> <span class="variable">$end</span><span class="operator">-</span><span class="variable">$start</span><span class="operator">;</span>
        <span class="keyword">my</span> <span class="variable">$term</span>          <span class="operator">=</span> <span class="keyword">substr</span><span class="operator">(</span><span class="variable">$string</span><span class="operator">,</span> <span class="variable">$start</span><span class="operator">,</span> <span class="variable">$len</span><span class="operator">);</span>
        <span class="keyword">return</span> <span class="operator">(</span><span class="variable">$term</span><span class="operator">,</span> <span class="variable">$len</span><span class="operator">,</span> <span class="variable">$start</span><span class="operator">,</span> <span class="variable">$end</span><span class="operator">,</span> <span class="variable">$term_index</span><span class="operator">++);</span>
      <span class="operator">}</span>
    <span class="operator">};</span>
  <span class="operator">}</span>
</code></code></pre>

<p>There must be three levels of subs, in a kind of &quot;Russian dolls&quot; structure, because :</p>

<ul>

<li><p>the external, named sub is called whenever accessing a FTS3 table with that tokenizer</p>

</li>
<li><p>the inner, anonymous sub is called whenever a new string needs to be tokenized (either for inserting new text into the table, or for analyzing a query).</p>

</li>
<li><p>the innermost, anonymous sub is called repeatedly for retrieving all terms within that string.</p>

</li>
</ul>

<p>Instead of writing tokenizers by hand, you can grab one of those already implemented in the <a>Search::Tokenizer</a> module :</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">Search::Tokenizer</span><span class="operator">;</span>
  <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">do</span><span class="operator">(&lt;&lt;</span><span class="default">""</span><span class="operator">)</span> <span class="keyword">or</span> <span class="keyword">die</span> <span class="variable">DBI::errstr</span><span class="operator">;</span><span class="string">
  CREATE ... USING fts3(&lt;columns&gt;, 
                        tokenize=perl 'Search::Tokenizer::unaccent')
  </span>
</code></code></pre>

<p>or you can use <a>&quot;new&quot; in Search::Tokenizer</a> to build your own tokenizer.</p>

<h2 id="Incomplete-handling-of-utf8-characters">Incomplete handling of utf8 characters</h2>

<p>The current FTS3 implementation in SQLite is far from complete with respect to utf8 handling : in particular, variable-length characters are not treated correctly by the builtin functions <code><code>offsets()</code></code> and <code><code>snippet()</code></code>.</p>

<h2 id="Database-space-for-FTS3">Database space for FTS3</h2>

<p>FTS3 stores a complete copy of the indexed documents, together with the fulltext index. On a large collection of documents, this can consume quite a lot of disk space. If copies of documents are also available as external resources (for example files on the filesystem), that space can sometimes be spared --- see the tip in the <a href="../../lib/DBD/SQLite/Cookbook.html#Sparing-database-disk-space">Cookbook</a>.</p>

<h1 id="R-TREE-SUPPORT">R* TREE SUPPORT</h1>

<p>The RTREE extension module within SQLite adds support for creating a R-Tree, a special index for range and multidimensional queries. This allows users to create tables that can be loaded with (as an example) geospatial data such as latitude/longitude coordinates for buildings within a city :</p>

<pre><code><code>  <span class="variable">CREATE</span> <span class="variable">VIRTUAL</span> <span class="variable">TABLE</span> <span class="variable">city_buildings</span> <span class="variable">USING</span> <span class="variable">rtree</span><span class="operator">(</span>
     <span class="variable">id</span><span class="operator">,</span>               <span class="operator">--</span> <span class="variable">Integer</span> <span class="variable">primary</span> <span class="variable">key</span>
     <span class="variable">minLong</span><span class="operator">,</span> <span class="variable">maxLong</span><span class="operator">,</span> <span class="operator">--</span> <span class="variable">Minimum</span> <span class="keyword">and</span> <span class="variable">maximum</span> <span class="variable">longitude</span>
     <span class="variable">minLat</span><span class="operator">,</span> <span class="variable">maxLat</span>    <span class="operator">--</span> <span class="variable">Minimum</span> <span class="keyword">and</span> <span class="variable">maximum</span> <span class="variable">latitude</span>
  <span class="operator">);</span>
</code></code></pre>

<p>then query which buildings overlap or are contained within a specified region:</p>

<pre><code><code>  <span class="comment"># IDs that are contained within query coordinates</span>
  <span class="keyword">my</span> <span class="variable">$contained_sql</span> <span class="operator">=</span> <span class="operator">&lt;&lt;</span><span class="default">""</span><span class="operator">;</span><span class="string">
  SELECT id FROM try_rtree
     WHERE  minLong &gt;= ? AND maxLong &lt;= ?
     AND    minLat  &gt;= ? AND maxLat  &lt;= ?
  </span>
  <span class="comment"># ... and those that overlap query coordinates</span>
  <span class="keyword">my</span> <span class="variable">$overlap_sql</span> <span class="operator">=</span> <span class="operator">&lt;&lt;</span><span class="default">""</span><span class="operator">;</span><span class="string">
  SELECT id FROM try_rtree
     WHERE    maxLong &gt;= ? AND minLong &lt;= ?
     AND      maxLat  &gt;= ? AND minLat  &lt;= ?
  </span>
  <span class="keyword">my</span> <span class="variable">$contained</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">selectcol_arrayref</span><span class="operator">(</span><span class="variable">$contained_sql</span><span class="operator">,</span><span class="keyword">undef</span><span class="operator">,</span>
                        <span class="variable">$minLong</span><span class="operator">,</span> <span class="variable">$maxLong</span><span class="operator">,</span> <span class="variable">$minLat</span><span class="operator">,</span> <span class="variable">$maxLat</span><span class="operator">);</span>
  
  <span class="keyword">my</span> <span class="variable">$overlapping</span> <span class="operator">=</span> <span class="variable">$dbh</span><span class="operator">-&gt;</span><span class="variable">selectcol_arrayref</span><span class="operator">(</span><span class="variable">$overlap_sql</span><span class="operator">,</span><span class="keyword">undef</span><span class="operator">,</span>
                        <span class="variable">$minLong</span><span class="operator">,</span> <span class="variable">$maxLong</span><span class="operator">,</span> <span class="variable">$minLat</span><span class="operator">,</span> <span class="variable">$maxLat</span><span class="operator">);</span>  
</code></code></pre>

<p>For more detail, please see the SQLite R-Tree page (<a href="http://www.sqlite.org/rtree.html">http://www.sqlite.org/rtree.html</a>). Note that custom R-Tree queries using callbacks, as mentioned in the prior link, have not been implemented yet.</p>

<h1 id="FOR-DBD::SQLITE-EXTENSION-AUTHORS">FOR DBD::SQLITE EXTENSION AUTHORS</h1>

<p>Since 1.30_01, you can retrieve the bundled sqlite C source and/or header like this:</p>

<pre><code><code>  <span class="keyword">use</span> <span class="variable">File::ShareDir</span> <span class="string">'dist_dir'</span><span class="operator">;</span>
  <span class="keyword">use</span> <span class="variable">File::Spec::Functions</span> <span class="string">'catfile'</span><span class="operator">;</span>
  
  <span class="comment"># the whole sqlite3.h header</span>
  <span class="keyword">my</span> <span class="variable">$sqlite3_h</span> <span class="operator">=</span> <span class="variable">catfile</span><span class="operator">(</span><span class="variable">dist_dir</span><span class="operator">(</span><span class="string">'DBD-SQLite'</span><span class="operator">),</span> <span class="string">'sqlite3.h'</span><span class="operator">);</span>
  
  <span class="comment"># or only a particular header, amalgamated in sqlite3.c</span>
  <span class="keyword">my</span> <span class="variable">$what_i_want</span> <span class="operator">=</span> <span class="string">'parse.h'</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$sqlite3_c</span> <span class="operator">=</span> <span class="variable">catfile</span><span class="operator">(</span><span class="variable">dist_dir</span><span class="operator">(</span><span class="string">'DBD-SQLite'</span><span class="operator">),</span> <span class="string">'sqlite3.c'</span><span class="operator">);</span>
  <span class="keyword">open</span> <span class="keyword">my</span> <span class="variable">$fh</span><span class="operator">,</span> <span class="string">'&lt;'</span><span class="operator">,</span> <span class="variable">$sqlite3_c</span> <span class="keyword">or</span> <span class="keyword">die</span> <span class="variable">$!</span><span class="operator">;</span>
  <span class="keyword">my</span> <span class="variable">$code</span> <span class="operator">=</span> <span class="keyword">do</span> <span class="operator">{</span> <span class="keyword">local</span> <span class="variable">$/</span><span class="operator">;</span> <span class="operator">&lt;</span><span class="variable">$fh</span><span class="operator">&gt;</span> <span class="operator">};</span>
  <span class="keyword">my</span> <span class="operator">(</span><span class="variable">$parse_h</span><span class="operator">)</span> <span class="operator">=</span> <span class="variable">$code</span> <span class="operator">=~</span> <span class="regex">m{(
    /\*+[ ]Begin[ ]file[ ]</span><span class="variable">$what_i_want</span><span class="regex">[ ]\*+
    .+?
    /\*+[ ]End[ ]of[ ]</span><span class="variable">$what_i_want</span><span class="regex">[ ]\*+/
  )}sx</span><span class="operator">;</span>
  <span class="keyword">open</span> <span class="keyword">my</span> <span class="variable">$out</span><span class="operator">,</span> <span class="string">'&gt;'</span><span class="operator">,</span> <span class="variable">$what_i_want</span> <span class="keyword">or</span> <span class="keyword">die</span> <span class="variable">$!</span><span class="operator">;</span>
  <span class="keyword">print</span> <span class="variable">$out</span> <span class="variable">$parse_h</span><span class="operator">;</span>
  <span class="keyword">close</span> <span class="variable">$out</span><span class="operator">;</span>
</code></code></pre>

<p>You usually want to use this in your extension&#39;s <code><code>Makefile.PL</code></code>, and you may want to add DBD::SQLite to your extension&#39;s <code><code>CONFIGURE_REQUIRES</code></code> to ensure your extension users use the same C source/header they use to build DBD::SQLite itself (instead of the ones installed in their system).</p>

<h1 id="TO-DO">TO DO</h1>

<p>The following items remain to be done.</p>

<h2 id="Leak-Detection">Leak Detection</h2>

<p>Implement one or more leak detection tests that only run during AUTOMATED_TESTING and RELEASE_TESTING and validate that none of the C code we work with leaks.</p>

<h2 id="Stream-API-for-Blobs">Stream API for Blobs</h2>

<p>Reading/writing into blobs using <code><code>sqlite2_blob_open</code></code> / <code><code>sqlite2_blob_close</code></code>.</p>

<h2 id="Flags-for-sqlite3_open_v2">Flags for sqlite3_open_v2</h2>

<p>Support the full API of sqlite3_open_v2 (flags for opening the file).</p>

<h2 id="Support-for-custom-callbacks-for-R-Tree-queries">Support for custom callbacks for R-Tree queries</h2>

<p>Custom queries of a R-Tree index using a callback are possible with the SQLite C API (<a href="http://www.sqlite.org/rtree.html">http://www.sqlite.org/rtree.html</a>), so one could potentially use a callback that narrowed the result set down based on a specific need, such as querying for overlapping circles.</p>

<h1 id="SUPPORT">SUPPORT</h1>

<p>Bugs should be reported via the CPAN bug tracker at</p>

<p><a href="http://rt.cpan.org/NoAuth/ReportBug.html?Queue=DBD-SQLite">http://rt.cpan.org/NoAuth/ReportBug.html?Queue=DBD-SQLite</a></p>

<p>Note that bugs of bundled sqlite library (i.e. bugs in <code><code>sqlite3.[ch]</code></code>) should be reported to the sqlite developers at sqlite.org via their bug tracker or via their mailing list.</p>

<h1 id="AUTHORS">AUTHORS</h1>

<p>Matt Sergeant &lt;matt@sergeant.org&gt;</p>

<p>Francis J. Lacoste &lt;flacoste@logreport.org&gt;</p>

<p>Wolfgang Sourdeau &lt;wolfgang@logreport.org&gt;</p>

<p>Adam Kennedy &lt;adamk@cpan.org&gt;</p>

<p>Max Maischein &lt;corion@cpan.org&gt;</p>

<p>Laurent Dami &lt;dami@cpan.org&gt;</p>

<p>Kenichi Ishigaki &lt;ishigaki@cpan.org&gt;</p>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<p>The bundled SQLite code in this distribution is Public Domain.</p>

<p>DBD::SQLite is copyright 2002 - 2007 Matt Sergeant.</p>

<p>Some parts copyright 2008 Francis J. Lacoste.</p>

<p>Some parts copyright 2008 Wolfgang Sourdeau.</p>

<p>Some parts copyright 2008 - 2012 Adam Kennedy.</p>

<p>Some parts copyright 2009 - 2012 Kenichi Ishigaki.</p>

<p>Some parts derived from <a>DBD::SQLite::Amalgamation</a> copyright 2008 Audrey Tang.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>

<p>The full text of the license can be found in the LICENSE file included with this module.</p>


</body>

</html>


